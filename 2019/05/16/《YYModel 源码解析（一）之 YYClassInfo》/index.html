
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>《YYModel 源码解析（一）之 YYClassInfo》 | DevZhang的博客小屋</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="CSAMEN">
    

    
    <meta name="description" content="《YYModel 源码解析（一）之 YYClassInfo》YYModel 是一个非常轻量级的 JSON 模型自动转换库，在其轻量级的代码下还保留着自动类型转换，类型安全，无侵入等特性，并且具有接近手写解析代码的超高性能。

简介打开源码，只有 5 个文件，可以说是非常轻量了，这样对于我们来查看学习源码是非常方便的。
YYModel.h 为调入的头文件，具体看 YYClassInfo     和">
<meta property="og:type" content="article">
<meta property="og:title" content="《YYModel 源码解析（一）之 YYClassInfo》">
<meta property="og:url" content="http://yoursite.com/2019/05/16/《YYModel 源码解析（一）之 YYClassInfo》/index.html">
<meta property="og:site_name" content="DevZhang的博客小屋">
<meta property="og:description" content="《YYModel 源码解析（一）之 YYClassInfo》YYModel 是一个非常轻量级的 JSON 模型自动转换库，在其轻量级的代码下还保留着自动类型转换，类型安全，无侵入等特性，并且具有接近手写解析代码的超高性能。

简介打开源码，只有 5 个文件，可以说是非常轻量了，这样对于我们来查看学习源码是非常方便的。
YYModel.h 为调入的头文件，具体看 YYClassInfo     和">
<meta property="og:image" content="http://yoursite.com/images/15580026777096.jpg">
<meta property="og:image" content="http://yoursite.com/images/15580026866143.jpg">
<meta property="og:image" content="http://yoursite.com/images/15580026965478.jpg">
<meta property="og:image" content="http://yoursite.com/images/15580028213233.jpg">
<meta property="og:image" content="http://yoursite.com/images/15580028295773.jpg">
<meta property="og:image" content="http://yoursite.com/images/15580027983210.jpg">
<meta property="og:image" content="http://yoursite.com/images/15580027428488.jpg">
<meta property="og:updated_time" content="2019-05-16T10:34:02.566Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《YYModel 源码解析（一）之 YYClassInfo》">
<meta name="twitter:description" content="《YYModel 源码解析（一）之 YYClassInfo》YYModel 是一个非常轻量级的 JSON 模型自动转换库，在其轻量级的代码下还保留着自动类型转换，类型安全，无侵入等特性，并且具有接近手写解析代码的超高性能。

简介打开源码，只有 5 个文件，可以说是非常轻量了，这样对于我们来查看学习源码是非常方便的。
YYModel.h 为调入的头文件，具体看 YYClassInfo     和">
<meta name="twitter:image" content="http://yoursite.com/images/15580026777096.jpg">

    
    <link rel="alternative" href="/atom.xml" title="DevZhang的博客小屋" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="DevZhang的博客小屋">DevZhang的博客小屋</a></h1>
				<h2 class="blog-motto">有生之莲</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/16/《YYModel 源码解析（一）之 YYClassInfo》/" title="《YYModel 源码解析（一）之 YYClassInfo》" itemprop="url">《YYModel 源码解析（一）之 YYClassInfo》</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="CSAMEN" target="_blank" itemprop="author">CSAMEN</a>
		
  <p class="article-time">
    <time datetime="2019-05-16T10:28:21.000Z" itemprop="datePublished"> 发表于 2019-05-16</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#《YYModel-源码解析（一）之-YYClassInfo》"><span class="toc-number">1.</span> <span class="toc-text">《YYModel 源码解析（一）之 YYClassInfo》</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YYClassInfo"><span class="toc-number">1.2.</span> <span class="toc-text">YYClassInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassIvarInfo-objc-ivar"><span class="toc-number">1.2.1.</span> <span class="toc-text">YYClassIvarInfo (objc_ivar)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#objc-ivar"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">objc_ivar</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YYEncodingType-amp-amp-YYEncodingGetType"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">YYEncodingType && YYEncodingGetType</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassMethodInfo-objc-method"><span class="toc-number">1.2.2.</span> <span class="toc-text">YYClassMethodInfo (objc_method)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassPropertyInfo-objc-property-t"><span class="toc-number">1.2.3.</span> <span class="toc-text">YYClassPropertyInfo (objc_property_t)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassInfo-objc-class"><span class="toc-number">1.2.4.</span> <span class="toc-text">YYClassInfo (objc_class)</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<h1 id="《YYModel-源码解析（一）之-YYClassInfo》"><a href="#《YYModel-源码解析（一）之-YYClassInfo》" class="headerlink" title="《YYModel 源码解析（一）之 YYClassInfo》"></a>《YYModel 源码解析（一）之 YYClassInfo》</h1><p>YYModel 是一个非常轻量级的 JSON 模型自动转换库，在其轻量级的代码下还保留着自动类型转换，类型安全，无侵入等特性，并且具有接近手写解析代码的超高性能。</p>
<p><img src="/images/15580026777096.jpg" alt="-w692"></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>打开源码，只有 5 个文件，可以说是非常轻量了，这样对于我们来查看学习源码是非常方便的。<br><img src="/images/15580026866143.jpg" alt="-w236"></p>
<p>YYModel.h 为调入的头文件，具体看 YYClassInfo     和 NSObject+YYModel 2 个模块即可。</p>
<ul>
<li>YYClassInfo 主要讲 runtime 层级的一些结构体封装到 NSObject 层级以便调用</li>
<li>NSObject+YYModel 开放出来各种接口调用以及实现具体的模型转换的逻辑（借助 YYClassInfo 中的封装）。</li>
</ul>
<h2 id="YYClassInfo"><a href="#YYClassInfo" class="headerlink" title="YYClassInfo"></a>YYClassInfo</h2><p>YYClassInfo 是对 runtime 一些结构体的封装，具体对应为：<br><img src="/images/15580026965478.jpg" alt="-w730"></p>
<h3 id="YYClassIvarInfo-objc-ivar"><a href="#YYClassIvarInfo-objc-ivar" class="headerlink" title="YYClassIvarInfo (objc_ivar)"></a>YYClassIvarInfo (objc_ivar)</h3><p>YYClassIvarInfo 是对 runtime 层 objc_ivar 结构体的封装，objc_ivar 表示变量的结构体</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> Instance variable information.</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassIvarInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Ivar ivar;              <span class="comment">///&lt; ivar opaque struct</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name;         <span class="comment">///&lt; Ivar's name</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) ptrdiff_t offset;       <span class="comment">///&lt; Ivar's offset</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *typeEncoding; <span class="comment">///&lt; Ivar's type encoding</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) YYEncodingType type;    <span class="comment">///&lt; Ivar's type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> Creates and returns an ivar info object.</span><br><span class="line"> </span><br><span class="line"> @param ivar ivar opaque struct</span><br><span class="line"> @return A new object, or nil if an error occurs.</span><br><span class="line"> */</span></span><br><span class="line">- (instancetype)initWithIvar:(Ivar)ivar;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYClassIvarInfo</span></span></span><br><span class="line"></span><br><span class="line">- (instancetype)initWithIvar:(Ivar)ivar &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ivar) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _ivar = ivar;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(ivar);</span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        _name = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">    &#125;</span><br><span class="line">    _offset = ivar_getOffset(ivar);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *typeEncoding = ivar_getTypeEncoding(ivar);</span><br><span class="line">    <span class="keyword">if</span> (typeEncoding) &#123;</span><br><span class="line">        _typeEncoding = [<span class="built_in">NSString</span> stringWithUTF8String:typeEncoding];</span><br><span class="line">        _type = YYEncodingGetType(typeEncoding);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>其实从这里就可以看出来，作者代码写的非常用心规范，添加了注释，开源出来真的是很方便别人学习。由上面源代码可以知道类中个属性的意义：</p>
<ul>
<li>ivar: 变量，对应 objc_ivar</li>
<li>name: 变量名称，通过 ivar_getName(ivar) 获得</li>
<li>offset: 变量偏移量，通过 ivar_getOffset(ivar) 获得</li>
<li>typeEncoding: 变量的类型编码字符串，通过 ivar_getTypeEncoding(ivar) 获得再转字符串</li>
<li>type: 变量类型，以上均是通过 runtime 方法获得信息，这里是作者自定义的 YYEncodingGetType 获得</li>
</ul>
<p>这里有两点需要注意一下：</p>
<h4 id="objc-ivar"><a href="#objc-ivar" class="headerlink" title="objc_ivar"></a>objc_ivar</h4><p>对应 runtime 源码版本 objc4-723:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_ivar &#123;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_name                               OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 变量名称</span></span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_type                          OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 变量类型</span></span><br><span class="line">    <span class="keyword">int</span> ivar_offset                                          OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 变量偏移量</span></span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 变量空间</span></span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="YYEncodingType-amp-amp-YYEncodingGetType"><a href="#YYEncodingType-amp-amp-YYEncodingGetType" class="headerlink" title="YYEncodingType &amp;&amp; YYEncodingGetType"></a>YYEncodingType &amp;&amp; YYEncodingGetType</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> Type encoding's type.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, YYEncodingType) &#123;</span><br><span class="line">    <span class="comment">// Objective-C type encodings</span></span><br><span class="line">    YYEncodingTypeMask       = <span class="number">0xFF</span>, <span class="comment">///&lt; mask of type value</span></span><br><span class="line">    YYEncodingTypeUnknown    = <span class="number">0</span>, <span class="comment">///&lt; unknown</span></span><br><span class="line">    YYEncodingTypeVoid       = <span class="number">1</span>, <span class="comment">///&lt; void</span></span><br><span class="line">    YYEncodingTypeBool       = <span class="number">2</span>, <span class="comment">///&lt; bool</span></span><br><span class="line">    YYEncodingTypeInt8       = <span class="number">3</span>, <span class="comment">///&lt; char / BOOL</span></span><br><span class="line">    YYEncodingType<span class="built_in">UInt8</span>      = <span class="number">4</span>, <span class="comment">///&lt; unsigned char</span></span><br><span class="line">    YYEncodingTypeInt16      = <span class="number">5</span>, <span class="comment">///&lt; short</span></span><br><span class="line">    YYEncodingType<span class="built_in">UInt16</span>     = <span class="number">6</span>, <span class="comment">///&lt; unsigned short</span></span><br><span class="line">    YYEncodingTypeInt32      = <span class="number">7</span>, <span class="comment">///&lt; int</span></span><br><span class="line">    YYEncodingType<span class="built_in">UInt32</span>     = <span class="number">8</span>, <span class="comment">///&lt; unsigned int</span></span><br><span class="line">    YYEncodingTypeInt64      = <span class="number">9</span>, <span class="comment">///&lt; long long</span></span><br><span class="line">    YYEncodingType<span class="built_in">UInt64</span>     = <span class="number">10</span>, <span class="comment">///&lt; unsigned long long</span></span><br><span class="line">    YYEncodingTypeFloat      = <span class="number">11</span>, <span class="comment">///&lt; float</span></span><br><span class="line">    YYEncodingTypeDouble     = <span class="number">12</span>, <span class="comment">///&lt; double</span></span><br><span class="line">    YYEncodingTypeLongDouble = <span class="number">13</span>, <span class="comment">///&lt; long double</span></span><br><span class="line">    YYEncodingTypeObject     = <span class="number">14</span>, <span class="comment">///&lt; id</span></span><br><span class="line">    YYEncodingTypeClass      = <span class="number">15</span>, <span class="comment">///&lt; Class</span></span><br><span class="line">    YYEncodingTypeSEL        = <span class="number">16</span>, <span class="comment">///&lt; SEL</span></span><br><span class="line">    YYEncodingTypeBlock      = <span class="number">17</span>, <span class="comment">///&lt; block</span></span><br><span class="line">    YYEncodingTypePointer    = <span class="number">18</span>, <span class="comment">///&lt; void*</span></span><br><span class="line">    YYEncodingTypeStruct     = <span class="number">19</span>, <span class="comment">///&lt; struct</span></span><br><span class="line">    YYEncodingTypeUnion      = <span class="number">20</span>, <span class="comment">///&lt; union</span></span><br><span class="line">    YYEncodingTypeCString    = <span class="number">21</span>, <span class="comment">///&lt; char*</span></span><br><span class="line">    YYEncodingType<span class="built_in">CArray</span>     = <span class="number">22</span>, <span class="comment">///&lt; char[10] (for example)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Objective-C method encodings</span></span><br><span class="line">    YYEncodingTypeQualifierMask   = <span class="number">0xFF00</span>,   <span class="comment">///&lt; mask of qualifier</span></span><br><span class="line">    YYEncodingTypeQualifierConst  = <span class="number">1</span> &lt;&lt; <span class="number">8</span>,  <span class="comment">///&lt; const</span></span><br><span class="line">    YYEncodingTypeQualifierIn     = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,  <span class="comment">///&lt; in</span></span><br><span class="line">    YYEncodingTypeQualifierInout  = <span class="number">1</span> &lt;&lt; <span class="number">10</span>, <span class="comment">///&lt; inout</span></span><br><span class="line">    YYEncodingTypeQualifierOut    = <span class="number">1</span> &lt;&lt; <span class="number">11</span>, <span class="comment">///&lt; out</span></span><br><span class="line">    YYEncodingTypeQualifierBycopy = <span class="number">1</span> &lt;&lt; <span class="number">12</span>, <span class="comment">///&lt; bycopy</span></span><br><span class="line">    YYEncodingTypeQualifierByref  = <span class="number">1</span> &lt;&lt; <span class="number">13</span>, <span class="comment">///&lt; byref</span></span><br><span class="line">    YYEncodingTypeQualifierOneway = <span class="number">1</span> &lt;&lt; <span class="number">14</span>, <span class="comment">///&lt; oneway</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Declared property type encodings</span></span><br><span class="line">    YYEncodingTypePropertyMask         = <span class="number">0xFF0000</span>, <span class="comment">///&lt; mask of property</span></span><br><span class="line">    YYEncodingTypePropertyReadonly     = <span class="number">1</span> &lt;&lt; <span class="number">16</span>, <span class="comment">///&lt; readonly</span></span><br><span class="line">    YYEncodingTypePropertyCopy         = <span class="number">1</span> &lt;&lt; <span class="number">17</span>, <span class="comment">///&lt; copy</span></span><br><span class="line">    YYEncodingTypePropertyRetain       = <span class="number">1</span> &lt;&lt; <span class="number">18</span>, <span class="comment">///&lt; retain</span></span><br><span class="line">    YYEncodingTypePropertyNonatomic    = <span class="number">1</span> &lt;&lt; <span class="number">19</span>, <span class="comment">///&lt; nonatomic</span></span><br><span class="line">    YYEncodingTypePropertyWeak         = <span class="number">1</span> &lt;&lt; <span class="number">20</span>, <span class="comment">///&lt; weak</span></span><br><span class="line">    YYEncodingTypePropertyCustomGetter = <span class="number">1</span> &lt;&lt; <span class="number">21</span>, <span class="comment">///&lt; getter=</span></span><br><span class="line">    YYEncodingTypePropertyCustomSetter = <span class="number">1</span> &lt;&lt; <span class="number">22</span>, <span class="comment">///&lt; setter=</span></span><br><span class="line">    YYEncodingTypePropertyDynamic      = <span class="number">1</span> &lt;&lt; <span class="number">23</span>, <span class="comment">///&lt; @dynamic</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>该 NS_OPTIONS 主要定义了 3 个大类 encode type:</p>
<ul>
<li>YYEncodingTypeMask：变量类型，类型只有一个所以直接定义数字占位</li>
<li>YYEncodingTypeQualifierMask：方法中的参数变量修饰符，理论上只有解析Method的参数才能解析到</li>
<li>YYEncodingTypePropertyMask：属性修饰类型</li>
</ul>
<p>YYEncodingTypeQualifierMask 和 YYEncodingTypePropertyMask 存在一对多的情况，所以使用位移的方式，通过 <strong>|</strong> 并存，通过 <strong>&amp;</strong> 运算判断是否包含某一个值。<br>这里用系统提供的 <strong>UIViewAutoresizing</strong> 为例：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">UIViewAutoresizing</span>) &#123;</span><br><span class="line">    <span class="built_in">UIViewAutoresizingNone</span>                 = <span class="number">0</span>,</span><br><span class="line">    <span class="built_in">UIViewAutoresizingFlexibleLeftMargin</span>   = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,</span><br><span class="line">    <span class="built_in">UIViewAutoresizingFlexibleWidth</span>        = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line">    <span class="built_in">UIViewAutoresizingFlexibleRightMargin</span>  = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line">    <span class="built_in">UIViewAutoresizingFlexibleTopMargin</span>    = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">    <span class="built_in">UIViewAutoresizingFlexibleHeight</span>       = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</span><br><span class="line">    <span class="built_in">UIViewAutoresizingFlexibleBottomMargin</span> = <span class="number">1</span> &lt;&lt; <span class="number">5</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIViewAutoresizing</span> autoresizingMask = <span class="built_in">UIViewAutoresizingNone</span>;</span><br><span class="line">    autoresizingMask |= <span class="built_in">UIViewAutoresizingFlexibleHeight</span>;</span><br><span class="line">    autoresizingMask |= <span class="built_in">UIViewAutoresizingFlexibleWidth</span>;</span><br><span class="line">    <span class="keyword">if</span> ((autoresizingMask &amp; <span class="built_in">UIViewAutoresizingFlexibleHeight</span>) == <span class="built_in">UIViewAutoresizingFlexibleHeight</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"包含 UIViewAutoresizingFlexibleHeight"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"不包含 UIViewAutoresizingFlexibleHeight"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((autoresizingMask &amp; <span class="built_in">UIViewAutoresizingFlexibleTopMargin</span>) == <span class="built_in">UIViewAutoresizingFlexibleTopMargin</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"包含 UIViewAutoresizingFlexibleTopMargin"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"不包含 UIViewAutoresizingFlexibleTopMargin"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：<br> 包含 UIViewAutoresizingFlexibleHeight, 不包含 UIViewAutoresizingFlexibleTopMargin</p>
<p>最后，这里是对于类型编码做了一层封装，关于类型编码作者在源码中也给出了参考链接，具体参考官方文档 <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">Type Encodings </a> 和 <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html" target="_blank" rel="external">Declared Properties</a>。<br><img src="/images/15580028213233.jpg" alt="-w623"><br><img src="/images/15580028295773.jpg" alt="-w172"></p>
<p>这里基本除了 <strong>const</strong> 其它修饰符都很少使用了， <a href="https://stackoverflow.com/questions/5609564/objective-c-in-out-inout-byref-byval-and-so-on-what-are-they" target="_blank" rel="external">so</a>上可以搜到讨论。</p>
<h3 id="YYClassMethodInfo-objc-method"><a href="#YYClassMethodInfo-objc-method" class="headerlink" title="YYClassMethodInfo (objc_method)"></a>YYClassMethodInfo (objc_method)</h3><p>对应 runtime 中的 objc_method，定义方法的结构体：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method &#123;</span><br><span class="line">    SEL _Nonnull method_name                                 OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 方法名</span></span><br><span class="line">    <span class="keyword">char</span> * _Nullable method_types                            OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 方法类型</span></span><br><span class="line">    IMP _Nonnull method_imp                                  OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 方法实现（函数指针）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YYClassMethodInfo:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassMethodInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Method method;                  <span class="comment">///&lt; method opaque struct</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name;                 <span class="comment">///&lt; method name</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) SEL sel;                        <span class="comment">///&lt; method's selector</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) IMP imp;                        <span class="comment">///&lt; method's implementation</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *typeEncoding;         <span class="comment">///&lt; method's parameter and return types</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *returnTypeEncoding;   <span class="comment">///&lt; return value's type</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *argumentTypeEncodings; <span class="comment">///&lt; array of arguments' type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> Creates and returns a method info object.</span><br><span class="line"> </span><br><span class="line"> @param method method opaque struct</span><br><span class="line"> @return A new object, or nil if an error occurs.</span><br><span class="line"> */</span></span><br><span class="line">- (instancetype)initWithMethod:(Method)method;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYClassMethodInfo</span></span></span><br><span class="line"></span><br><span class="line">- (instancetype)initWithMethod:(Method)method &#123;</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _method = method;</span><br><span class="line">    _sel = method_getName(method);</span><br><span class="line">    _imp = method_getImplementation(method);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = sel_getName(_sel);</span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        _name = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *typeEncoding = method_getTypeEncoding(method);</span><br><span class="line">    <span class="keyword">if</span> (typeEncoding) &#123;</span><br><span class="line">        _typeEncoding = [<span class="built_in">NSString</span> stringWithUTF8String:typeEncoding];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> *returnType = method_copyReturnType(method);</span><br><span class="line">    <span class="keyword">if</span> (returnType) &#123;</span><br><span class="line">        _returnTypeEncoding = [<span class="built_in">NSString</span> stringWithUTF8String:returnType];</span><br><span class="line">        free(returnType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> argumentCount = method_getNumberOfArguments(method);</span><br><span class="line">    <span class="keyword">if</span> (argumentCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *argumentTypes = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argumentCount; i++) &#123;</span><br><span class="line">            <span class="keyword">char</span> *argumentType = method_copyArgumentType(method, i);</span><br><span class="line">            <span class="built_in">NSString</span> *type = argumentType ? [<span class="built_in">NSString</span> stringWithUTF8String:argumentType] : <span class="literal">nil</span>;</span><br><span class="line">            [argumentTypes addObject:type ? type : <span class="string">@""</span>];</span><br><span class="line">            <span class="keyword">if</span> (argumentType) free(argumentType);</span><br><span class="line">        &#125;</span><br><span class="line">        _argumentTypeEncodings = argumentTypes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>对应的属性（基本都是通过 runtime 来获取）：</p>
<ul>
<li>method: 方法</li>
<li>name: 方法名称</li>
<li>sel: 方法选择器，通过 method_getName(method) 获取</li>
<li>imp: 方法实现，通过 method_getImplementation(method) 获取</li>
<li>typeEncoding: 方法参数和返回类型编码，通过 method_getTypeEncoding(method) 获取</li>
<li>returnTypeEncoding: 返回值类型编码，通过 method_copyReturnType(method) 获取</li>
<li>argumentTypeEncodings: 参数类型编码数组，先通过 method_getNumberOfArguments(method) 获取参数个数，然后通过 method_copyArgumentType 依次获取方法参数类型并塞入数组中</li>
</ul>
<h3 id="YYClassPropertyInfo-objc-property-t"><a href="#YYClassPropertyInfo-objc-property-t" class="headerlink" title="YYClassPropertyInfo (objc_property_t)"></a>YYClassPropertyInfo (objc_property_t)</h3><p>objc_property:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t;</span><br><span class="line"></span><br><span class="line"><span class="comment">// objc-private.h</span></span><br><span class="line"><span class="meta">#if __OBJC2__</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> property_t *objc_property_t;</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> old_property *objc_property_t;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"><span class="keyword">struct</span> property_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *attributes;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassPropertyInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) objc_property_t property; <span class="comment">///&lt; property's opaque struct</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name;           <span class="comment">///&lt; property's name</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) YYEncodingType type;      <span class="comment">///&lt; property's type</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *typeEncoding;   <span class="comment">///&lt; property's encoding value</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *ivarName;       <span class="comment">///&lt; property's ivar name</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class cls;      <span class="comment">///&lt; may be nil</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *protocols; <span class="comment">///&lt; may nil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) SEL getter;               <span class="comment">///&lt; getter (nonnull)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) SEL setter;               <span class="comment">///&lt; setter (nonnull)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> Creates and returns a property info object.</span><br><span class="line"> </span><br><span class="line"> @param property property opaque struct</span><br><span class="line"> @return A new object, or nil if an error occurs.</span><br><span class="line"> */</span></span><br><span class="line">- (instancetype)initWithProperty:(objc_property_t)property;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>对应属性：</p>
<ul>
<li>property: 对应 objc_property_t</li>
<li>name: 属性名字，通过  property_getName(property) 获取</li>
<li>type: 属性类型，先根据 property_copyAttributeList 获取 objc_property_attribute_t （包含 name 和 value 直接对应类型编码的值），然后遍历属性个数，</li>
<li>typeEncoding: 属性类型编码</li>
<li>ivarName: 变量名称</li>
<li>cls: 类型</li>
<li>protocols: 属性相关协议</li>
<li>getter: getter 方法选择器</li>
<li>setter: setter 方法选择器</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYClassPropertyInfo</span></span></span><br><span class="line"></span><br><span class="line">- (instancetype)initWithProperty:(objc_property_t)property &#123;</span><br><span class="line">    <span class="keyword">if</span> (!property) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _property = property;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(property);</span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        _name = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    YYEncodingType type = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> attrCount;</span><br><span class="line">    objc_property_attribute_t *attrs = property_copyAttributeList(property, &amp;attrCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attrCount; i++) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (attrs[i].name[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'T'</span>: &#123; <span class="comment">// Type encoding</span></span><br><span class="line">                <span class="keyword">if</span> (attrs[i].value) &#123;</span><br><span class="line">                    <span class="comment">// objc_property_attribute_t.value 直接对应 _typeEncoding</span></span><br><span class="line">                    _typeEncoding = [<span class="built_in">NSString</span> stringWithUTF8String:attrs[i].value];</span><br><span class="line">                    <span class="comment">// 转成 YYEncodingType</span></span><br><span class="line">                    type = YYEncodingGetType(attrs[i].value);</span><br><span class="line">                    <span class="comment">// 如果类型是 OC 对象，把 OC 对象解析出来，如 @"NSString"</span></span><br><span class="line">                    <span class="keyword">if</span> ((type &amp; YYEncodingTypeMask) == YYEncodingTypeObject &amp;&amp; _typeEncoding.length) &#123;</span><br><span class="line">                        <span class="built_in">NSScanner</span> *scanner = [<span class="built_in">NSScanner</span> scannerWithString:_typeEncoding];</span><br><span class="line">                        <span class="comment">// 先扫描到 @" 的位置</span></span><br><span class="line">                        <span class="keyword">if</span> (![scanner scanString:<span class="string">@"@\""</span> intoString:<span class="literal">NULL</span>]) <span class="keyword">continue</span>;</span><br><span class="line">                        </span><br><span class="line">                        <span class="built_in">NSString</span> *clsName = <span class="literal">nil</span>;</span><br><span class="line">                        <span class="comment">// 然后扫描至存在"或者&lt;的位置，这是因为如果遵循了协议 typeEncode 就是 @"NSString&lt;NSCopy&gt;" 了</span></span><br><span class="line">                        <span class="keyword">if</span> ([scanner scanUpToCharactersFromSet: [<span class="built_in">NSCharacterSet</span> characterSetWithCharactersInString:<span class="string">@"\"&lt;"</span>] intoString:&amp;clsName]) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (clsName.length) _cls = objc_getClass(clsName.UTF8String);</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="built_in">NSMutableArray</span> *protocols = <span class="literal">nil</span>;</span><br><span class="line">                        <span class="comment">// 如果遵循多个协议 typecoding 是这样的 @"NSString&lt;NSCopy&gt;&lt;NSObject&gt;"，所以将扫描位置移动到 &lt; 位置，循环截取</span></span><br><span class="line">                        <span class="keyword">while</span> ([scanner scanString:<span class="string">@"&lt;"</span> intoString:<span class="literal">NULL</span>]) &#123;</span><br><span class="line">                            <span class="built_in">NSString</span>* protocol = <span class="literal">nil</span>;</span><br><span class="line">                            <span class="keyword">if</span> ([scanner scanUpToString:<span class="string">@"&gt;"</span> intoString: &amp;protocol]) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (protocol.length) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (!protocols) protocols = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">                                    [protocols addObject:protocol];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            [scanner scanString:<span class="string">@"&gt;"</span> intoString:<span class="literal">NULL</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                        _protocols = protocols;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'V'</span>: &#123; <span class="comment">// Instance variable</span></span><br><span class="line">                <span class="keyword">if</span> (attrs[i].value) &#123;</span><br><span class="line">                    _ivarName = [<span class="built_in">NSString</span> stringWithUTF8String:attrs[i].value];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'R'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyReadonly;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'C'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyCopy;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&amp;'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyRetain;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'N'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyNonatomic;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'D'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyDynamic;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'W'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyWeak;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'G'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyCustomGetter;</span><br><span class="line">                <span class="keyword">if</span> (attrs[i].value) &#123;</span><br><span class="line">                    _getter = <span class="built_in">NSSelectorFromString</span>([<span class="built_in">NSString</span> stringWithUTF8String:attrs[i].value]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'S'</span>: &#123;</span><br><span class="line">                type |= YYEncodingTypePropertyCustomSetter;</span><br><span class="line">                <span class="keyword">if</span> (attrs[i].value) &#123;</span><br><span class="line">                    _setter = <span class="built_in">NSSelectorFromString</span>([<span class="built_in">NSString</span> stringWithUTF8String:attrs[i].value]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="comment">// break; commented for code coverage in next line</span></span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (attrs) &#123;</span><br><span class="line">        free(attrs);</span><br><span class="line">        attrs = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _type = type;</span><br><span class="line">    <span class="keyword">if</span> (_name.length) &#123;</span><br><span class="line">        <span class="comment">// 如果 getter setter 为 nil，手动生成下</span></span><br><span class="line">        <span class="keyword">if</span> (!_getter) &#123;</span><br><span class="line">            _getter = <span class="built_in">NSSelectorFromString</span>(_name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!_setter) &#123;</span><br><span class="line">            _setter = <span class="built_in">NSSelectorFromString</span>([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@%@:"</span>, [_name substringToIndex:<span class="number">1</span>].uppercaseString, [_name substringFromIndex:<span class="number">1</span>]]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>这里有个简单的例子：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">UserDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)addAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">User</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> height;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span>&lt;UserDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">User</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">User *user = [[User alloc] init];</span><br><span class="line">    user.name = <span class="string">@"zrz"</span>;</span><br><span class="line">    user.age = <span class="number">18</span>;</span><br><span class="line">    user.height = <span class="number">180</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span> UserClass = objc_getClass(<span class="string">"User"</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount, i;</span><br><span class="line">    <span class="comment">// 获取属性列表</span></span><br><span class="line">    objc_property_t *properties = class_copyPropertyList(UserClass, &amp;outCount);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">        objc_property_t property = properties[i];</span><br><span class="line">        <span class="comment">// property_getName: 获取属性名</span></span><br><span class="line">        <span class="comment">// property_getAttributes: 获取属性 @encode type 字符串（ T 开头然后紧跟着 @encode 类型，中间逗号隔开，末尾 V 跟着实例变量名 ）</span></span><br><span class="line">        <span class="comment">// name T@"NSString",&amp;,N,V_name</span></span><br><span class="line">        <span class="comment">// age Tq,N,V_age</span></span><br><span class="line">        <span class="comment">// height Td,N,V_height</span></span><br><span class="line">        fprintf(stdout, <span class="string">"%s %s\n"</span>, property_getName(property), property_getAttributes(property));</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> attrCount;</span><br><span class="line">        objc_property_attribute_t *attrs = property_copyAttributeList(property, &amp;attrCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; attrCount; j++) &#123;</span><br><span class="line">            fprintf(stdout, <span class="string">"name:%s value:%s\n"</span>, attrs[j].name, attrs[j].value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/15580027983210.jpg" alt="-w390"></p>
<h3 id="YYClassInfo-objc-class"><a href="#YYClassInfo-objc-class" class="headerlink" title="YYClassInfo (objc_class)"></a>YYClassInfo (objc_class)</h3><p><strong>objc_class</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">// runtime.h</span></span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa OBJC_ISA_<span class="built_in">AVAILABILITY</span>; <span class="comment">// isa 指针</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 父类（超类）指针</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 类名</span></span><br><span class="line">    <span class="keyword">long</span> version OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 版本</span></span><br><span class="line">    <span class="keyword">long</span> info OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 信息</span></span><br><span class="line">    <span class="keyword">long</span> instance_size OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 初始尺寸</span></span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 变量列表</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 方法列表</span></span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 缓存</span></span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols OBJC2_UN<span class="built_in">AVAILABLE</span>; <span class="comment">// 协议列表</span></span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br></pre></td></tr></table></figure>
<p>声明文件：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class cls; <span class="comment">// 所属类</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class superCls; <span class="comment">// 超类</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class metaCls; <span class="comment">// 元类</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isMetal; <span class="comment">// 是否是元类</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> * name; <span class="comment">// 类名</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYClassInfo * superClassInfo; <span class="comment">// 超类的 classInfo</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, YYClassIvarInfo *&gt; *ivarInfos; <span class="comment">// 属性集合，以字典的形式存储，key是成员变量名</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, YYClassMethodInfo *&gt; *methodInfos; <span class="comment">// 方法集合，以字典形式存储，key是方法名</span></span><br><span class="line"><span class="keyword">@property</span> (nullable, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, YYClassPropertyInfo *&gt; *propertyInfos; <span class="comment">// 属性名，以字典形式存储，key是属性名</span></span><br><span class="line"><span class="comment">// 如果类改变了（例如：你向这个类中添加了方法 'class_addMethod()'，你应该调用这个方法去刷新这个类信息缓存，调用这个方法之后 ‘needUpdate’ 将会返回 'YES'，并且你应该调用 ‘classInfoWithClass’ 或者 'classInfoWithClassName' 去获得更新的类信息）</span></span><br><span class="line">- (<span class="keyword">void</span>)setNeedUpdate;</span><br><span class="line"><span class="comment">// 如果该方法返回 ‘YES’，则需要调用下面 2 个方法重新获得类信息</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)needUpdate;</span><br><span class="line"><span class="comment">// 根据 cls 获取类信息 YYClassInfo</span></span><br><span class="line">+ (nullable instancetype)classInfoWithClass:(Class)cls;</span><br><span class="line"><span class="comment">//根据 className 获取类信息 YYClassInfo</span></span><br><span class="line">+ (nullable instancetype)classInfoWithClassName:(<span class="built_in">NSString</span> *)className;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>实现文件：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYClassInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> _needUpdate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithClass:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _cls = cls;</span><br><span class="line">    <span class="comment">// 获取超类</span></span><br><span class="line">    _superCls = class_getSuperclass(cls);</span><br><span class="line">    <span class="comment">// 判断当前类是否为元类，不是则获取</span></span><br><span class="line">    _isMeta = class_isMetaClass(cls);</span><br><span class="line">    <span class="keyword">if</span> (!_isMeta) &#123;</span><br><span class="line">        _metaCls = objc_getMetaClass(class_getName(cls));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取类名</span></span><br><span class="line">    _name = <span class="built_in">NSStringFromClass</span>(cls);</span><br><span class="line">    [<span class="keyword">self</span> _update];</span><br><span class="line">    <span class="comment">// 递归获取超类信息，直到超类为 nil</span></span><br><span class="line">    _superClassInfo = [<span class="keyword">self</span>.class classInfoWithClass:_superCls];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)_update &#123;</span><br><span class="line">    <span class="comment">// 重置各字典</span></span><br><span class="line">    _ivarInfos = <span class="literal">nil</span>;</span><br><span class="line">    _methodInfos = <span class="literal">nil</span>;</span><br><span class="line">    _propertyInfos = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    Class cls = <span class="keyword">self</span>.cls;</span><br><span class="line">    <span class="comment">// 获取方法集合（以方法名为 key）</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> methodCount = <span class="number">0</span>;</span><br><span class="line">    Method *methods = class_copyMethodList(cls, &amp;methodCount);</span><br><span class="line">    <span class="keyword">if</span> (methods) &#123;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *methodInfos = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        _methodInfos = methodInfos;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</span><br><span class="line">            YYClassMethodInfo *info = [[YYClassMethodInfo alloc] initWithMethod:methods[i]];</span><br><span class="line">            <span class="keyword">if</span> (info.name) methodInfos[info.name] = info;</span><br><span class="line">        &#125;</span><br><span class="line">        free(methods);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取属性集合（以属性名为 key）</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> propertyCount = <span class="number">0</span>;</span><br><span class="line">    objc_property_t *properties = class_copyPropertyList(cls, &amp;propertyCount);</span><br><span class="line">    <span class="keyword">if</span> (properties) &#123;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *propertyInfos = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        _propertyInfos = propertyInfos;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyCount; i++) &#123;</span><br><span class="line">            YYClassPropertyInfo *info = [[YYClassPropertyInfo alloc] initWithProperty:properties[i]];</span><br><span class="line">            <span class="keyword">if</span> (info.name) propertyInfos[info.name] = info;</span><br><span class="line">        &#125;</span><br><span class="line">        free(properties);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取属性集合（以成员变量为 key）</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> ivarCount = <span class="number">0</span>;</span><br><span class="line">    Ivar *ivars = class_copyIvarList(cls, &amp;ivarCount);</span><br><span class="line">    <span class="keyword">if</span> (ivars) &#123;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *ivarInfos = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        _ivarInfos = ivarInfos;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ivarCount; i++) &#123;</span><br><span class="line">            YYClassIvarInfo *info = [[YYClassIvarInfo alloc] initWithIvar:ivars[i]];</span><br><span class="line">            <span class="keyword">if</span> (info.name) ivarInfos[info.name] = info;</span><br><span class="line">        &#125;</span><br><span class="line">        free(ivars);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置默认空字典</span></span><br><span class="line">    <span class="keyword">if</span> (!_ivarInfos) _ivarInfos = @&#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (!_methodInfos) _methodInfos = @&#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (!_propertyInfos) _propertyInfos = @&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// needUpdate 默认为空，为 YES 时需要重新获取信息</span></span><br><span class="line">    _needUpdate = <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNeedUpdate &#123;</span><br><span class="line">    _needUpdate = <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)needUpdate &#123;</span><br><span class="line">    <span class="keyword">return</span> _needUpdate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)classInfoWithClass:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableDictionaryRef</span> classCache;   <span class="comment">// class 缓存</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableDictionaryRef</span> metaCache;    <span class="comment">// 元类 缓存</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="comment">// 加锁，线程安全</span></span><br><span class="line">    <span class="keyword">static</span> dispatch_semaphore_t lock;</span><br><span class="line">    <span class="comment">// 单例，初始化两种缓存</span></span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        classCache = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;k<span class="built_in">CFTypeDictionaryKeyCallBacks</span>, &amp;k<span class="built_in">CFTypeDictionaryValueCallBacks</span>);</span><br><span class="line">        metaCache = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;k<span class="built_in">CFTypeDictionaryKeyCallBacks</span>, &amp;k<span class="built_in">CFTypeDictionaryValueCallBacks</span>);</span><br><span class="line">        lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="comment">// 先获取缓存</span></span><br><span class="line">    YYClassInfo *info = <span class="built_in">CFDictionaryGetValue</span>(class_isMetaClass(cls) ? metaCache : classCache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(cls));</span><br><span class="line">    <span class="comment">// 如果有缓存并且需要更新，则更新数据</span></span><br><span class="line">    <span class="keyword">if</span> (info &amp;&amp; info-&gt;_needUpdate) &#123;</span><br><span class="line">        [info _update];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_semaphore_signal(lock);</span><br><span class="line">    <span class="keyword">if</span> (!info) &#123;    <span class="comment">// 如果没有缓存则初始化</span></span><br><span class="line">        info = [[YYClassInfo alloc] initWithClass:cls];</span><br><span class="line">        <span class="keyword">if</span> (info) &#123;</span><br><span class="line">            <span class="comment">// 将 clssInfo 存入缓存中</span></span><br><span class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">            <span class="comment">// 判断是否是元类，key 为 cls, value 为实例化的 YYClassInfo 分别存入 metaCache/classCache 字典中</span></span><br><span class="line">            <span class="built_in">CFDictionarySetValue</span>(info.isMeta ? metaCache : classCache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(cls), (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(info));</span><br><span class="line">            dispatch_semaphore_signal(lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)classInfoWithClassName:(<span class="built_in">NSString</span> *)className &#123;</span><br><span class="line">    Class cls = <span class="built_in">NSClassFromString</span>(className);</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> classInfoWithClass:cls];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到作者对于 runtime 使用相当熟练，运用了大量的 runtime 层 api</p>
<p><img src="/images/15580027428488.jpg" alt=""></p>
<p>这里简单说明一下：</p>
<ul>
<li>isa 指针，用于找到所属类，类对象的 isa 一般指向对应元类。</li>
<li>元类，由于 objc_class 继承于 objc_object，即类本身同时也是一个对象，所以 Runtime 库设计出元类用以表述类对象自身所具备的元数据。</li>
</ul>
<p>YYClassInfo 初始化的过程总结一下：</p>
<ul>
<li>创建单例缓存，类缓存和元类缓存</li>
<li>通过 <strong>dispatch_semaphore</strong> 加锁保证线程安全</li>
<li>初始化前先判断是否有缓存，通过缓存提高效率</li>
<li>如果查找到有缓存，判断是否需要更新缓存，如果需要则更新</li>
<li>如果没有查找到缓存，则进行初始化</li>
<li>初始化成功之后将 <strong>YYClassInfo</strong> 实例存入到缓存中</li>
</ul>
<p>另外：</p>
<blockquote>
<p>这里使用了 <strong>CFMutableDictionaryRef</strong> 而不是 <strong>NSMutableDictionary</strong>, 因为 C 函数使用性能更高一点。。</p>
</blockquote>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2019/05/16/《YYModel 源码解析（一）之 YYClassInfo》/" data-title="《YYModel 源码解析（一）之 YYClassInfo》 | DevZhang的博客小屋" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2019/05/10/《Effective Objective-C 2.0 编写高质量 iOS 与 OS X 代码的 52 个有效方法》笔记/"  title="《Effective Objective-C 2.0 编写高质量 iOS 与 OS X 代码的 52 个有效方法》笔记">
 <strong>下一篇：</strong><br/> 
 <span>《Effective Objective-C 2.0 编写高质量 iOS 与 OS X 代码的 52 个有效方法》笔记
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#《YYModel-源码解析（一）之-YYClassInfo》"><span class="toc-number">1.</span> <span class="toc-text">《YYModel 源码解析（一）之 YYClassInfo》</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YYClassInfo"><span class="toc-number">1.2.</span> <span class="toc-text">YYClassInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassIvarInfo-objc-ivar"><span class="toc-number">1.2.1.</span> <span class="toc-text">YYClassIvarInfo (objc_ivar)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#objc-ivar"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">objc_ivar</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YYEncodingType-amp-amp-YYEncodingGetType"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">YYEncodingType && YYEncodingGetType</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassMethodInfo-objc-method"><span class="toc-number">1.2.2.</span> <span class="toc-text">YYClassMethodInfo (objc_method)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassPropertyInfo-objc-property-t"><span class="toc-number">1.2.3.</span> <span class="toc-text">YYClassPropertyInfo (objc_property_t)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassInfo-objc-class"><span class="toc-number">1.2.4.</span> <span class="toc-text">YYClassInfo (objc_class)</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  

  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> 积跬步以至千里 <br/>
			凭栏眺望会有时</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="CSAMEN">CSAMEN</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
