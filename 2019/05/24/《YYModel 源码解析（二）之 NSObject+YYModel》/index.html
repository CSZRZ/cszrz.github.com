
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>《YYModel 源码解析（二）之 NSObject+YYModel》 | DevZhang的博客小屋</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="CSAMEN">
    

    
    <meta name="description" content="《YYModel 源码解析（二）之 NSObject+YYModel》该文件对外暴露各种接口，内部主要做了定义了数据结构，类型的编码解析，JSON 和 Model 的转换。
类型编码解析YYEncodingNSTypeFoundation 类型枚举123456789101112131415161718typedef NS_ENUM (NSUInteger, YYEncodingNSType) &amp;#">
<meta property="og:type" content="article">
<meta property="og:title" content="《YYModel 源码解析（二）之 NSObject+YYModel》">
<meta property="og:url" content="http://yoursite.com/2019/05/24/《YYModel 源码解析（二）之 NSObject+YYModel》/index.html">
<meta property="og:site_name" content="DevZhang的博客小屋">
<meta property="og:description" content="《YYModel 源码解析（二）之 NSObject+YYModel》该文件对外暴露各种接口，内部主要做了定义了数据结构，类型的编码解析，JSON 和 Model 的转换。
类型编码解析YYEncodingNSTypeFoundation 类型枚举123456789101112131415161718typedef NS_ENUM (NSUInteger, YYEncodingNSType) &amp;#">
<meta property="og:image" content="http://yoursite.com/images/15586842468911.jpg">
<meta property="og:updated_time" content="2019-05-24T07:51:40.038Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《YYModel 源码解析（二）之 NSObject+YYModel》">
<meta name="twitter:description" content="《YYModel 源码解析（二）之 NSObject+YYModel》该文件对外暴露各种接口，内部主要做了定义了数据结构，类型的编码解析，JSON 和 Model 的转换。
类型编码解析YYEncodingNSTypeFoundation 类型枚举123456789101112131415161718typedef NS_ENUM (NSUInteger, YYEncodingNSType) &amp;#">
<meta name="twitter:image" content="http://yoursite.com/images/15586842468911.jpg">

    
    <link rel="alternative" href="/atom.xml" title="DevZhang的博客小屋" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="DevZhang的博客小屋">DevZhang的博客小屋</a></h1>
				<h2 class="blog-motto">有生之莲</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/24/《YYModel 源码解析（二）之 NSObject+YYModel》/" title="《YYModel 源码解析（二）之 NSObject+YYModel》" itemprop="url">《YYModel 源码解析（二）之 NSObject+YYModel》</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="CSAMEN" target="_blank" itemprop="author">CSAMEN</a>
		
  <p class="article-time">
    <time datetime="2019-05-24T07:49:30.000Z" itemprop="datePublished"> 发表于 2019-05-24</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#《YYModel-源码解析（二）之-NSObject-YYModel》"><span class="toc-number">1.</span> <span class="toc-text">《YYModel 源码解析（二）之 NSObject+YYModel》</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#类型编码解析"><span class="toc-number">1.1.</span> <span class="toc-text">类型编码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYEncodingNSType"><span class="toc-number">1.1.1.</span> <span class="toc-text">YYEncodingNSType</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassGetNSType"><span class="toc-number">1.1.2.</span> <span class="toc-text">YYClassGetNSType</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYEncodingTypeIsCNumber"><span class="toc-number">1.1.3.</span> <span class="toc-text">YYEncodingTypeIsCNumber</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYNSNumberCreateFromID"><span class="toc-number">1.1.4.</span> <span class="toc-text">YYNSNumberCreateFromID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYNSDateFromString"><span class="toc-number">1.1.5.</span> <span class="toc-text">YYNSDateFromString</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYNSBlockClass"><span class="toc-number">1.1.6.</span> <span class="toc-text">YYNSBlockClass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#强制内联"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">强制内联</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据结构的定义"><span class="toc-number">1.2.</span> <span class="toc-text">数据结构的定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYModelPropertyMeta"><span class="toc-number">1.2.1.</span> <span class="toc-text">_YYModelPropertyMeta</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYModelMeta"><span class="toc-number">1.2.2.</span> <span class="toc-text">_YYModelMeta</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对外开放的接口"><span class="toc-number">1.3.</span> <span class="toc-text">对外开放的接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSArray-YYModel"><span class="toc-number">1.3.1.</span> <span class="toc-text">NSArray (YYModel)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSDictionary-YYModel"><span class="toc-number">1.3.2.</span> <span class="toc-text">NSDictionary (YYModel)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#model-转-JSON-data"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">model 转 JSON data</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#model-转-JSON"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">model 转 JSON</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-和-Model-的互转"><span class="toc-number">1.4.</span> <span class="toc-text">JSON 和 Model 的互转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON-to-Model"><span class="toc-number">1.4.1.</span> <span class="toc-text">JSON to Model</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-to-NSDictionary"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">JSON to NSDictionary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSDictionary-to-Model"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">NSDictionary to Model</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Model-to-JSON"><span class="toc-number">1.4.2.</span> <span class="toc-text">Model to JSON</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">1.6.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="《YYModel-源码解析（二）之-NSObject-YYModel》"><a href="#《YYModel-源码解析（二）之-NSObject-YYModel》" class="headerlink" title="《YYModel 源码解析（二）之 NSObject+YYModel》"></a>《YYModel 源码解析（二）之 NSObject+YYModel》</h1><p>该文件对外暴露各种接口，内部主要做了定义了数据结构，类型的编码解析，JSON 和 Model 的转换。</p>
<h2 id="类型编码解析"><a href="#类型编码解析" class="headerlink" title="类型编码解析"></a>类型编码解析</h2><h3 id="YYEncodingNSType"><a href="#YYEncodingNSType" class="headerlink" title="YYEncodingNSType"></a>YYEncodingNSType</h3><p><strong>Foundation</strong> 类型枚举<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span> (<span class="built_in">NSUInteger</span>, YYEncoding<span class="built_in">NSType</span>) &#123;</span><br><span class="line">    YYEncodingType<span class="built_in">NSUnknown</span> = <span class="number">0</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSString</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSMutableString</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSValue</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSNumber</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSDecimalNumber</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSData</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSMutableData</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSDate</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSURL</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSArray</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSMutableArray</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSDictionary</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSMutableDictionary</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSSet</span>,</span><br><span class="line">    YYEncodingType<span class="built_in">NSMutableSet</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="YYClassGetNSType"><a href="#YYClassGetNSType" class="headerlink" title="YYClassGetNSType"></a>YYClassGetNSType</h3><p>配合上面的枚举，根据 <strong>class</strong> 类型返回对应的 <strong>YYEncodingNSType</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> force_inline YYEncoding<span class="built_in">NSType</span> YYClassGet<span class="built_in">NSType</span>(Class cls) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSUnknown</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableString</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSMutableString</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSString</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSString</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSDecimalNumber</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSDecimalNumber</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSNumber</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSNumber</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSValue</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSValue</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableData</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSMutableData</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSData</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSData</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSDate</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSDate</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSURL</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSURL</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableArray</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSMutableArray</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSArray</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSArray</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableDictionary</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSMutableDictionary</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSDictionary</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSDictionary</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSMutableSet</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSMutableSet</span>;</span><br><span class="line">    <span class="keyword">if</span> ([cls isSubclassOfClass:[<span class="built_in">NSSet</span> class]]) <span class="keyword">return</span> YYEncodingType<span class="built_in">NSSet</span>;</span><br><span class="line">    <span class="keyword">return</span> YYEncodingType<span class="built_in">NSUnknown</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="YYEncodingTypeIsCNumber"><a href="#YYEncodingTypeIsCNumber" class="headerlink" title="YYEncodingTypeIsCNumber"></a>YYEncodingTypeIsCNumber</h3><p>判断 <strong>YYEncodingType</strong> 是否可以转为 C Number<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">BOOL</span> YYEncodingTypeIsCNumber(YYEncodingType type) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeBool:    <span class="comment">// bool</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt8:    <span class="comment">// char / BOOL</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt8</span>:   <span class="comment">// unsigned char</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt16:   <span class="comment">// short</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt16</span>:  <span class="comment">// unsigned short</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt32:   <span class="comment">// int</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt32</span>:  <span class="comment">// unsigned int</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeInt64:   <span class="comment">// long long</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt64</span>:  <span class="comment">// unsigned long long</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeFloat:   <span class="comment">// float</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeDouble:  <span class="comment">// double</span></span><br><span class="line">        <span class="keyword">case</span> YYEncodingTypeLongDouble: <span class="keyword">return</span> <span class="literal">YES</span>;  <span class="comment">// long double</span></span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="YYNSNumberCreateFromID"><a href="#YYNSNumberCreateFromID" class="headerlink" title="YYNSNumberCreateFromID"></a>YYNSNumberCreateFromID</h3><p>将 <strong>id</strong> 类型转为 <strong>NSNumber</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">NSNumber</span> *YY<span class="built_in">NSNumberCreateFromID</span>(__unsafe_unretained <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="comment">// 字符合集</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSCharacterSet</span> *dot;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSDictionary</span> *dic;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// 字符 '.' 对应数字 46，这里等价 dot = [NSCharacterSet characterSetWithRange:NSMakeRange(46, 1)];</span></span><br><span class="line">        <span class="comment">// 相当于创建一个 NSCharacterSet 对象，其中只包含 '.' 这一个 Character</span></span><br><span class="line">        dot = [<span class="built_in">NSCharacterSet</span> characterSetWithRange:<span class="built_in">NSMakeRange</span>(<span class="string">'.'</span>, <span class="number">1</span>)];</span><br><span class="line">        <span class="comment">// 穷举一个 dict，真假值和空，兼容了各种写法</span></span><br><span class="line">        dic = @&#123;<span class="string">@"TRUE"</span> :   @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"True"</span> :   @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"true"</span> :   @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"FALSE"</span> :  @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"False"</span> :  @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"false"</span> :  @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"YES"</span> :    @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"Yes"</span> :    @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"yes"</span> :    @(<span class="literal">YES</span>),</span><br><span class="line">                <span class="string">@"NO"</span> :     @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"No"</span> :     @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"no"</span> :     @(<span class="literal">NO</span>),</span><br><span class="line">                <span class="string">@"NIL"</span> :    (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"Nil"</span> :    (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"nil"</span> :    (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"NULL"</span> :   (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"Null"</span> :   (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"null"</span> :   (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"(NULL)"</span> : (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"(Null)"</span> : (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"(null)"</span> : (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"&lt;NULL&gt;"</span> : (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"&lt;Null&gt;"</span> : (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>,</span><br><span class="line">                <span class="string">@"&lt;null&gt;"</span> : (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>&#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// value 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!value || value == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// number 类型直接返回</span></span><br><span class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSNumber</span> class]]) <span class="keyword">return</span> value;</span><br><span class="line">    <span class="comment">// 如果是字符串</span></span><br><span class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;</span><br><span class="line">        <span class="comment">// 先从穷举 dict 中取值</span></span><br><span class="line">        <span class="built_in">NSNumber</span> *num = dic[value];</span><br><span class="line">        <span class="comment">// 如果不为 nil （说明 value 为真假值或者空值）</span></span><br><span class="line">        <span class="keyword">if</span> (num != <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果为 kCFNull 返回 nil</span></span><br><span class="line">            <span class="keyword">if</span> (num == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果字符串中包含 ’.‘ 字符</span></span><br><span class="line">        <span class="keyword">if</span> ([(<span class="built_in">NSString</span> *)value rangeOfCharacterFromSet:dot].location != <span class="built_in">NSNotFound</span>) &#123;</span><br><span class="line">            <span class="comment">// 字符串转字符</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *cstring = ((<span class="built_in">NSString</span> *)value).UTF8String;</span><br><span class="line">            <span class="keyword">if</span> (!cstring) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// 字符转 double</span></span><br><span class="line">            <span class="keyword">double</span> num = atof(cstring);</span><br><span class="line">            <span class="comment">// num 如果不是数字或者w无穷则返回 nil</span></span><br><span class="line">            <span class="keyword">if</span> (isnan(num) || isinf(num)) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">return</span> @(num);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *cstring = ((<span class="built_in">NSString</span> *)value).UTF8String;</span><br><span class="line">            <span class="keyword">if</span> (!cstring) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// 返回长长整形</span></span><br><span class="line">            <span class="keyword">return</span> @(atoll(cstring));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="YYNSDateFromString"><a href="#YYNSDateFromString" class="headerlink" title="YYNSDateFromString"></a>YYNSDateFromString</h3><p>把日期字符串转成 <strong>NSDate</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">NSDate</span> *YY<span class="built_in">NSDateFromString</span>(__unsafe_unretained <span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="built_in">NSDate</span>* (^YY<span class="built_in">NSDateParseBlock</span>)(<span class="built_in">NSString</span> *string);</span><br><span class="line">    <span class="comment">// YYNSDateFromString 支持解析的最长时间字符串</span></span><br><span class="line">    <span class="meta">#define kParserNum 34</span></span><br><span class="line">    <span class="comment">// 这里申明了一个 block 数组，下标对应时间字符串长度</span></span><br><span class="line">    <span class="keyword">static</span> YY<span class="built_in">NSDateParseBlock</span> blocks[kParserNum + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">// 创建单例初始化 NSDateFormatter（该类初始化开销比较大，一般都会在单例中初始化）</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// 单例里面基本穷举了各种时间格式</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span><br><span class="line">             2014-01-20  // Google</span><br><span class="line">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter.dateFormat = <span class="string">@"yyyy-MM-dd"</span>;</span><br><span class="line">            <span class="comment">// 将时间格式转换的函数闭包存入 block 数组，对应的数组下标就是字符串长度，最后只要根据根据字符串长度从 block 数组中取出对应的闭包对象解析转换格式。</span></span><br><span class="line">            blocks[<span class="number">10</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span><br><span class="line">             2014-01-20 12:24:48</span><br><span class="line">             2014-01-20T12:24:48   // Google</span><br><span class="line">             2014-01-20 12:24:48.000</span><br><span class="line">             2014-01-20T12:24:48.000</span><br><span class="line">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter1 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter1.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter1.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter1.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ss"</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter2 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter2.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter2.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter2.dateFormat = <span class="string">@"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter3 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter3.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter3.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter3.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ss.SSS"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter4 = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter4.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter4.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter4.dateFormat = <span class="string">@"yyyy-MM-dd HH:mm:ss.SSS"</span>;</span><br><span class="line">            </span><br><span class="line">            blocks[<span class="number">19</span>] = ^(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([string characterAtIndex:<span class="number">10</span>] == <span class="string">'T'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> [formatter1 dateFromString:string];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> [formatter2 dateFromString:string];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            blocks[<span class="number">23</span>] = ^(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([string characterAtIndex:<span class="number">10</span>] == <span class="string">'T'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> [formatter3 dateFromString:string];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> [formatter4 dateFromString:string];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span><br><span class="line">             2014-01-20T12:24:48Z        // Github, Apple</span><br><span class="line">             2014-01-20T12:24:48+0800    // Facebook</span><br><span class="line">             2014-01-20T12:24:48+12:00   // Google</span><br><span class="line">             2014-01-20T12:24:48.000Z</span><br><span class="line">             2014-01-20T12:24:48.000+0800</span><br><span class="line">             2014-01-20T12:24:48.000+12:00</span><br><span class="line">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ssZ"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter2 = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter2.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter2.dateFormat = <span class="string">@"yyyy-MM-dd'T'HH:mm:ss.SSSZ"</span>;</span><br><span class="line"></span><br><span class="line">            blocks[<span class="number">20</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">24</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]?: [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">25</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">28</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">29</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span><br><span class="line">             Fri Sep 04 00:12:21 +0800 2015 // Weibo, Twitter</span><br><span class="line">             Fri Sep 04 00:12:21.000 +0800 2015</span><br><span class="line">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter.dateFormat = <span class="string">@"EEE MMM dd HH:mm:ss Z yyyy"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter2 = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">            formatter2.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">            formatter2.dateFormat = <span class="string">@"EEE MMM dd HH:mm:ss.SSS Z yyyy"</span>;</span><br><span class="line"></span><br><span class="line">            blocks[<span class="number">30</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">            blocks[<span class="number">34</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter2 dateFromString:string]; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!string) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 超出能解析的时间格式的最大长度直接返回 nil</span></span><br><span class="line">    <span class="keyword">if</span> (string.length &gt; kParserNum) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 根据字符串长度取出对应的闭包对象</span></span><br><span class="line">    YY<span class="built_in">NSDateParseBlock</span> parser = blocks[string.length];</span><br><span class="line">    <span class="comment">// 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!parser) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 闭包解析将字符串转成 NSDate</span></span><br><span class="line">    <span class="keyword">return</span> parser(string);</span><br><span class="line">    <span class="comment">// 取消宏定义避免冲突</span></span><br><span class="line">    <span class="meta">#undef kParserNum</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="YYNSBlockClass"><a href="#YYNSBlockClass" class="headerlink" title="YYNSBlockClass"></a>YYNSBlockClass</h3><p>获取 <strong>NSBlock</strong> 类<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> force_inline Class YY<span class="built_in">NSBlockClass</span>() &#123;</span><br><span class="line">    <span class="keyword">static</span> Class cls;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// 先定义一个 block</span></span><br><span class="line">        <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;&#125;;</span><br><span class="line">        <span class="comment">// 获取 block 的 class</span></span><br><span class="line">        cls = ((<span class="built_in">NSObject</span> *)block).class;</span><br><span class="line">        <span class="comment">// 循环直到父类是 NSObject 为止</span></span><br><span class="line">        <span class="keyword">while</span> (class_getSuperclass(cls) != [<span class="built_in">NSObject</span> class]) &#123;</span><br><span class="line">            cls = class_getSuperclass(cls);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 最终这个类就是 NSBlock （NSBlock 是 OC 中闭包隐藏的根类，继承自 NSObject）</span></span><br><span class="line">    <span class="keyword">return</span> cls; <span class="comment">// current is "NSBlock"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="强制内联"><a href="#强制内联" class="headerlink" title="强制内联"></a>强制内联</h4><p>补充一点，这里随处可见宏 <strong>force_inline</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define force_inline __inline__ __attribute__((always_inline))</span></span><br></pre></td></tr></table></figure></p>
<p>这是一个强制内联的宏，关于内联和强制内联，内联函数和宏定义的区别可以参考<a href="https://blog.csdn.net/puppet_master/article/details/48550393" target="_blank" rel="external">这里</a>，简单的小结一下就是：</p>
<ul>
<li>宏的定义有二义性，由预处理器进行替换</li>
<li>内联函数则是通过编译器控制实现的，是函数，在程序用到的时候直接会像宏那样展开，这样可以大大的减少调用函数的性能损失（参数的压栈，状态的保存，返回结果等等）</li>
</ul>
<h2 id="数据结构的定义"><a href="#数据结构的定义" class="headerlink" title="数据结构的定义"></a>数据结构的定义</h2><p>这里定义了 2 个类 <strong>_YYModelPropertyMeta</strong> 和 <strong>_YYModelMeta</strong> </p>
<h3 id="YYModelPropertyMeta"><a href="#YYModelPropertyMeta" class="headerlink" title="_YYModelPropertyMeta"></a>_YYModelPropertyMeta</h3><p><strong>_YYModelPropertyMeta</strong> 基于 <strong>YYClassPropertyInfo</strong> 二次封装，表示模型对象中的属性信息<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYModelPropertyMeta</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    @package</span><br><span class="line">    <span class="built_in">NSString</span> *_name;             <span class="comment">// 属性名字</span></span><br><span class="line">    YYEncodingType _type;        <span class="comment">// 属性类型</span></span><br><span class="line">    YYEncoding<span class="built_in">NSType</span> _nsType;    <span class="comment">// 属性在 Foundation 中类型</span></span><br><span class="line">    <span class="built_in">BOOL</span> _isCNumber;             <span class="comment">// 是否为 C number</span></span><br><span class="line">    Class _cls;                  <span class="comment">// 属性类没有为 nil</span></span><br><span class="line">    Class _genericCls;           <span class="comment">// 属性包含的泛型类，没有为 nil 数组，字典之类指定了泛型</span></span><br><span class="line">    SEL _getter;                 <span class="comment">// getter 无法响应则为 nil</span></span><br><span class="line">    SEL _setter;                 <span class="comment">// setter</span></span><br><span class="line">    <span class="built_in">BOOL</span> _isKVCCompatible;       <span class="comment">// 如果可以使用 KVC 则为 YES</span></span><br><span class="line">    <span class="built_in">BOOL</span> _isStructAvailableForKeyedArchiver; <span class="comment">// 如果可以使用 archiver/unarchiver 归档解档则为 YES</span></span><br><span class="line">    <span class="built_in">BOOL</span> _hasCustomClassFromDictionary; <span class="comment">// 如果类或者泛型类使用了 +modelCustomClassForDictionary: 自定义类型转换则为 YES</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     property-&gt;key:       _mappedToKey:key     _mappedToKeyPath:nil            _mappedToKeyArray:nil</span><br><span class="line">     property-&gt;keyPath:   _mappedToKey:keyPath _mappedToKeyPath:keyPath(array) _mappedToKeyArray:nil</span><br><span class="line">     property-&gt;keys:      _mappedToKey:keys[0] _mappedToKeyPath:nil/keyPath    _mappedToKeyArray:keys(array)</span><br><span class="line">     */</span></span><br><span class="line">    <span class="built_in">NSString</span> *_mappedToKey;      <span class="comment">// 映射 key</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_mappedToKeyPath;   <span class="comment">// 映射 keyPath，没有则返回 nil</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_mappedToKeyArray;  <span class="comment">// 字符串 key 或者 数组 key Path</span></span><br><span class="line">    YYClassPropertyInfo *_info;  <span class="comment">// 属性信息</span></span><br><span class="line">    _YYModelPropertyMeta *_next; <span class="comment">// 如果有多个属性映射到同一个 key，则指向下一个属性元</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_YYModelPropertyMeta</span></span></span><br><span class="line">+ (instancetype)metaWithClassInfo:(YYClassInfo *)classInfo propertyInfo:(YYClassPropertyInfo *)propertyInfo generic:(Class)generic &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果属性对应的泛型类为空，但是属性有 protocol，尝试将 protocol 转为 Class</span></span><br><span class="line">    <span class="comment">// 这里属于做了一个强行纠错（当有同名的协议和模型时，开发者可能会将 NSArray&lt;Model *&gt; 写错成 NSArray&lt;protocol&gt; 这里尝试将 protocol 转为 Class 获取同名的模型，使得在这样的情况下也能正常解析）</span></span><br><span class="line">    <span class="keyword">if</span> (!generic &amp;&amp; propertyInfo.protocols) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *protocol <span class="keyword">in</span> propertyInfo.protocols) &#123;</span><br><span class="line">            Class cls = objc_getClass(protocol.UTF8String);</span><br><span class="line">            <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">                generic = cls;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 YYClassPropertyInfo 属性值赋值给 _YYModelPropertyMeta</span></span><br><span class="line">    _YYModelPropertyMeta *meta = [<span class="keyword">self</span> new];</span><br><span class="line">    meta-&gt;_name = propertyInfo.name;    <span class="comment">// 属性名</span></span><br><span class="line">    meta-&gt;_type = propertyInfo.type;    <span class="comment">// 属性类型</span></span><br><span class="line">    meta-&gt;_info = propertyInfo;         <span class="comment">// YYClassPropertyInfo</span></span><br><span class="line">    meta-&gt;_genericCls = generic;        <span class="comment">// 属性对应泛型类 NSArray&lt;Student *&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((meta-&gt;_type &amp; YYEncodingTypeMask) == YYEncodingTypeObject) &#123;</span><br><span class="line">        <span class="comment">// 如果是属性类型是对象，获取对应 Foundation 类型并且赋值</span></span><br><span class="line">        meta-&gt;_nsType = YYClassGet<span class="built_in">NSType</span>(propertyInfo.cls);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 判断属性类型是不是 C number</span></span><br><span class="line">        meta-&gt;_isCNumber = YYEncodingTypeIsCNumber(meta-&gt;_type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果属性是结构体</span></span><br><span class="line">    <span class="keyword">if</span> ((meta-&gt;_type &amp; YYEncodingTypeMask) == YYEncodingTypeStruct) &#123;</span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         It seems that NSKeyedUnarchiver cannot decode NSValue except these structs:</span><br><span class="line">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">NSSet</span> *types = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">        <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">            <span class="built_in">NSMutableSet</span> *set = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">            <span class="comment">// 32 bit</span></span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGSize=ff&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGPoint=ff&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGRect=&#123;CGPoint=ff&#125;&#123;CGSize=ff&#125;&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGAffineTransform=ffffff&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;UIEdgeInsets=ffff&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;UIOffset=ff&#125;"</span>];</span><br><span class="line">            <span class="comment">// 64 bit</span></span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGSize=dd&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGPoint=dd&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;CGAffineTransform=dddddd&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;UIEdgeInsets=dddd&#125;"</span>];</span><br><span class="line">            [set addObject:<span class="string">@"&#123;UIOffset=dd&#125;"</span>];</span><br><span class="line">            types = set;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 如果集合中包含有属性类型编码字符串，则说明该结构体支持归档解档</span></span><br><span class="line">        <span class="keyword">if</span> ([types containsObject:propertyInfo.typeEncoding]) &#123;</span><br><span class="line">            meta-&gt;_isStructAvailableForKeyedArchiver = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    meta-&gt;_cls = propertyInfo.cls;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断是否响应 modelCustomClassForDictionary 赋值 _hasCustomClassFromDictionary</span></span><br><span class="line">    <span class="keyword">if</span> (generic) &#123;</span><br><span class="line">        meta-&gt;_hasCustomClassFromDictionary = [generic respondsToSelector:<span class="keyword">@selector</span>(modelCustomClassForDictionary:)];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta-&gt;_cls &amp;&amp; meta-&gt;_nsType == YYEncodingType<span class="built_in">NSUnknown</span>) &#123;</span><br><span class="line">        meta-&gt;_hasCustomClassFromDictionary = [meta-&gt;_cls respondsToSelector:<span class="keyword">@selector</span>(modelCustomClassForDictionary:)];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断是否响应 getter 方法赋值</span></span><br><span class="line">    <span class="keyword">if</span> (propertyInfo.getter) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([classInfo.cls instancesRespondToSelector:propertyInfo.getter]) &#123;</span><br><span class="line">            meta-&gt;_getter = propertyInfo.getter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否响应 setter 方法</span></span><br><span class="line">    <span class="keyword">if</span> (propertyInfo.setter) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([classInfo.cls instancesRespondToSelector:propertyInfo.setter]) &#123;</span><br><span class="line">            meta-&gt;_setter = propertyInfo.setter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果有 getter 和 setter 方法</span></span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;_getter &amp;&amp; meta-&gt;_setter) &#123;</span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         KVC invalid type:</span><br><span class="line">         long double</span><br><span class="line">         pointer (such as SEL/CoreFoundation object)</span><br><span class="line">         */</span></span><br><span class="line">        <span class="comment">// 根据属性类型判断是否支持 KVC</span></span><br><span class="line">        <span class="keyword">switch</span> (meta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeBool:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeInt8:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt8</span>:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeInt16:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt16</span>:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeInt32:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt32</span>:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeInt64:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingType<span class="built_in">UInt64</span>:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeFloat:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeDouble:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeObject:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeClass:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeBlock:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeStruct:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeUnion: &#123;</span><br><span class="line">                meta-&gt;_isKVCCompatible = <span class="literal">YES</span>;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> meta;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<h3 id="YYModelMeta"><a href="#YYModelMeta" class="headerlink" title="_YYModelMeta"></a>_YYModelMeta</h3><p><strong>_YYModelMeta</strong> 是基于 <strong>YYClassInfo</strong> 的二次封装<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYModelMeta</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    @package</span><br><span class="line">    YYClassInfo *_classInfo;</span><br><span class="line">    <span class="comment">// key: 被映射的 key 和 keyPath, value:_YYModelPropertyMeta</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *_mapper;</span><br><span class="line">    <span class="comment">// Array&lt;_YYModelPropertyMeta&gt;, 当前模型的所有 _YYModelPropertyMeta 数组</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_allPropertyMetas;</span><br><span class="line">    <span class="comment">// Array&lt;_YYModelPropertyMeta&gt;, 被映射到 keyPath 的 _YYModelPropertyMeta 数组</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_keyPathPropertyMetas;</span><br><span class="line">    <span class="comment">// Array&lt;_YYModelPropertyMeta&gt;, 被映射到多个 key 的 _YYModelPropertyMeta 数组</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_multiKeysPropertyMetas;</span><br><span class="line">    <span class="comment">// 映射 key 和 keyPath 的数量，等同于 _mapper.count.</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _keyMappedCount;</span><br><span class="line">    <span class="comment">// 模型 clss 类型</span></span><br><span class="line">    YYEncoding<span class="built_in">NSType</span> _nsType;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否实现各自定义方法</span></span><br><span class="line">    <span class="built_in">BOOL</span> _hasCustomWillTransformFromDictionary;</span><br><span class="line">    <span class="built_in">BOOL</span> _hasCustomTransformFromDictionary;</span><br><span class="line">    <span class="built_in">BOOL</span> _hasCustomTransformToDictionary;</span><br><span class="line">    <span class="built_in">BOOL</span> _hasCustomClassFromDictionary;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_YYModelMeta</span></span></span><br><span class="line">- (instancetype)initWithClass:(Class)cls &#123;</span><br><span class="line">    <span class="comment">// 初始化 classInfo</span></span><br><span class="line">    YYClassInfo *classInfo = [YYClassInfo classInfoWithClass:cls];</span><br><span class="line">    <span class="keyword">if</span> (!classInfo) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取黑名单 (转换过程中忽略黑名单中属性)</span></span><br><span class="line">    <span class="built_in">NSSet</span> *blacklist = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 类如果响应 modelPropertyBlacklist 方法</span></span><br><span class="line">    <span class="keyword">if</span> ([cls respondsToSelector:<span class="keyword">@selector</span>(modelPropertyBlacklist)]) &#123;</span><br><span class="line">        <span class="comment">// 获得黑名单里面的属性数组</span></span><br><span class="line">        <span class="built_in">NSArray</span> *properties = [(<span class="keyword">id</span>&lt;YYModel&gt;)cls modelPropertyBlacklist];</span><br><span class="line">        <span class="keyword">if</span> (properties) &#123;</span><br><span class="line">            blacklist = [<span class="built_in">NSSet</span> setWithArray:properties];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取白名单（转换过程中只处理白名单中属性）</span></span><br><span class="line">    <span class="built_in">NSSet</span> *whitelist = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 类如果响应 modelPropertyWhitelist 方法</span></span><br><span class="line">    <span class="keyword">if</span> ([cls respondsToSelector:<span class="keyword">@selector</span>(modelPropertyWhitelist)]) &#123;</span><br><span class="line">        <span class="comment">// 获得白名单里面的属性数组</span></span><br><span class="line">        <span class="built_in">NSArray</span> *properties = [(<span class="keyword">id</span>&lt;YYModel&gt;)cls modelPropertyWhitelist];</span><br><span class="line">        <span class="keyword">if</span> (properties) &#123;</span><br><span class="line">            whitelist = [<span class="built_in">NSSet</span> setWithArray:properties];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得容器属性的映射类（当属性对象为容器对象 NSArray/NSSet/NSDictionary，需要做容器属性和类的映射关系）</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *genericMapper = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 如果实现了 modelContainerPropertyGenericClass 方法</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    @class Shadow, Border, Attachment;</span><br><span class="line">    </span><br><span class="line">    @interface Attributes</span><br><span class="line">    @property NSString *name;</span><br><span class="line">    @property NSArray *shadows; //Array&lt;Shadow&gt;</span><br><span class="line">    @property NSSet *borders; //Set&lt;Border&gt;</span><br><span class="line">    @property NSMutableDictionary *attachments; //Dict&lt;NSString,Attachment&gt;</span><br><span class="line">    @end</span><br><span class="line">    </span><br><span class="line">    @implementation Attributes</span><br><span class="line">    + (NSDictionary *)modelContainerPropertyGenericClass &#123;</span><br><span class="line">        // value should be Class or Class name.</span><br><span class="line">        return @&#123;@"shadows" : [Shadow class],</span><br><span class="line">                 @"borders" : Border.class,</span><br><span class="line">                 @"attachments" : @"Attachment" &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    @end **/</span></span><br><span class="line">    <span class="comment">// 因为支持多种写法，所以遍历处理一下字典，使得 key 为字符串，value 为 class</span></span><br><span class="line">    <span class="keyword">if</span> ([cls respondsToSelector:<span class="keyword">@selector</span>(modelContainerPropertyGenericClass)]) &#123;</span><br><span class="line">        <span class="comment">// 获得映射的字典 value 为 Class 或者 Class name （value 的值：[Student class], Student.class, @"Student"）</span></span><br><span class="line">        genericMapper = [(<span class="keyword">id</span>&lt;YYModel&gt;)cls modelContainerPropertyGenericClass];</span><br><span class="line">        <span class="keyword">if</span> (genericMapper) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *tmp = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">            <span class="comment">// 遍历字典</span></span><br><span class="line">            [genericMapper enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> key, <span class="keyword">id</span> obj, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">                <span class="comment">// 容错处理，如果 key 不是字符串直接返回</span></span><br><span class="line">                <span class="keyword">if</span> (![key isKindOfClass:[<span class="built_in">NSString</span> class]]) <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">// 获取属性对应的 class</span></span><br><span class="line">                Class meta = object_getClass(obj);</span><br><span class="line">                <span class="comment">// 如果 meta 为 nil 直接返回</span></span><br><span class="line">                <span class="keyword">if</span> (!meta) <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">// 如果该 class 为元类 如 [Student class], Student.class</span></span><br><span class="line">                <span class="keyword">if</span> (class_isMetaClass(meta)) &#123;</span><br><span class="line">                    <span class="comment">// 存入临时字典</span></span><br><span class="line">                    tmp[key] = obj;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([obj isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;  <span class="comment">// 如果是字符串如 @"Student"</span></span><br><span class="line">                    Class cls = <span class="built_in">NSClassFromString</span>(obj);</span><br><span class="line">                    <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">                        tmp[key] = cls;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">            <span class="comment">// 赋值给 genericMapper，key保持不变，value 为模型对应的 Class</span></span><br><span class="line">            genericMapper = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建所有的 _YYModelPropertyMeta 存到 allPropertyMetas 数组中(包含父类中属性)</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *allPropertyMetas = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">    YYClassInfo *curClassInfo = classInfo;</span><br><span class="line">    <span class="keyword">while</span> (curClassInfo &amp;&amp; curClassInfo.superCls != <span class="literal">nil</span>) &#123; <span class="comment">// 循环解析父类，但是忽略根类 (NSObject/NSProxy)</span></span><br><span class="line">        <span class="comment">// 遍历类中的所有属性信息</span></span><br><span class="line">        <span class="keyword">for</span> (YYClassPropertyInfo *propertyInfo <span class="keyword">in</span> curClassInfo.propertyInfos.allValues) &#123;</span><br><span class="line">            <span class="comment">// 属性名为空忽略</span></span><br><span class="line">            <span class="keyword">if</span> (!propertyInfo.name) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 忽略黑名单中的属性</span></span><br><span class="line">            <span class="keyword">if</span> (blacklist &amp;&amp; [blacklist containsObject:propertyInfo.name]) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 忽略白名单之外的属性</span></span><br><span class="line">            <span class="keyword">if</span> (whitelist &amp;&amp; ![whitelist containsObject:propertyInfo.name]) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 初始化 _YYModelPropertyMeta</span></span><br><span class="line">            _YYModelPropertyMeta *meta = [_YYModelPropertyMeta metaWithClassInfo:classInfo</span><br><span class="line">                                                                    propertyInfo:propertyInfo</span><br><span class="line">                                                                         generic:genericMapper[propertyInfo.name]];</span><br><span class="line">            <span class="comment">// 判断 meta 为空，或者 meta name 为空则跳过</span></span><br><span class="line">            <span class="keyword">if</span> (!meta || !meta-&gt;_name) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// meta 没有 getter 或者 setter 跳过</span></span><br><span class="line">            <span class="keyword">if</span> (!meta-&gt;_getter || !meta-&gt;_setter) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 字典中包含了跳过</span></span><br><span class="line">            <span class="keyword">if</span> (allPropertyMetas[meta-&gt;_name]) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 存入字典，key 为属性名，value 为 _YYModelPropertyMeta</span></span><br><span class="line">            allPropertyMetas[meta-&gt;_name] = meta;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获得当前类的父类</span></span><br><span class="line">        curClassInfo = curClassInfo.superClassInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从 allPropertyMetas 字典中取出 value 赋值给 _allPropertyMetas 数组</span></span><br><span class="line">    <span class="keyword">if</span> (allPropertyMetas.count) _allPropertyMetas = allPropertyMetas.allValues.copy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create mapper</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mapper = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *keyPathPropertyMetas = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *multiKeysPropertyMetas = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果有实现 modelCustomPropertyMapper</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     // JSON:</span><br><span class="line">     &#123;</span><br><span class="line">     "n":"Harry Pottery",</span><br><span class="line">     "p": 256,</span><br><span class="line">     "ext" : &#123;</span><br><span class="line">     "desc" : "A book written by J.K.Rowing."</span><br><span class="line">     &#125;,</span><br><span class="line">     "ID" : 100010</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     // Model:</span><br><span class="line">     @interface Book : NSObject</span><br><span class="line">     @property NSString *name;</span><br><span class="line">     @property NSInteger page;</span><br><span class="line">     @property NSString *desc;</span><br><span class="line">     @property NSString *bookID;</span><br><span class="line">     @end</span><br><span class="line">     @implementation Book</span><br><span class="line">     //返回一个 Dict，将 Model 属性名对映射到 JSON 的 Key。</span><br><span class="line">     + (NSDictionary *)modelCustomPropertyMapper &#123;</span><br><span class="line">     return @&#123;@"name" : @"n",</span><br><span class="line">     @"page" : @"p",</span><br><span class="line">     @"desc" : @"ext.desc",</span><br><span class="line">     @"bookID" : @[@"id",@"ID",@"book_id"]&#125;;</span><br><span class="line">     &#125;</span><br><span class="line">     @end</span><br><span class="line">     **/</span></span><br><span class="line">    <span class="keyword">if</span> ([cls respondsToSelector:<span class="keyword">@selector</span>(modelCustomPropertyMapper)]) &#123;</span><br><span class="line">        <span class="comment">// 获取自定义字典</span></span><br><span class="line">        <span class="built_in">NSDictionary</span> *customMapper = [(<span class="keyword">id</span> &lt;YYModel&gt;)cls modelCustomPropertyMapper];</span><br><span class="line">        <span class="comment">// 遍历字典</span></span><br><span class="line">        [customMapper enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *propertyName, <span class="built_in">NSString</span> *mappedToKey, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="comment">//通过自定义映射中的属性名从所有属性字典 allPropertyMetas 中获取对应的 _YYModelPropertyMeta （由 key 找到 model 的属性）</span></span><br><span class="line">            _YYModelPropertyMeta *propertyMeta = allPropertyMetas[propertyName];</span><br><span class="line">            <span class="comment">// 找不到直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (!propertyMeta) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">// 将该属性对应的信息从 allPropertyMetas 中删除</span></span><br><span class="line">            [allPropertyMetas removeObjectForKey:propertyName];</span><br><span class="line">            <span class="comment">// 如果需要映射的值是一个字符串 e.g. @"ext.desc" , @"dec"</span></span><br><span class="line">            <span class="keyword">if</span> ([mappedToKey isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mappedToKey.length == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">                </span><br><span class="line">                propertyMeta-&gt;_mappedToKey = mappedToKey;</span><br><span class="line">                <span class="comment">// "." 分割字符串拆分成数组 keyPath</span></span><br><span class="line">                <span class="built_in">NSArray</span> *keyPath = [mappedToKey componentsSeparatedByString:<span class="string">@"."</span>];</span><br><span class="line">                <span class="comment">// 遍历数组</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">NSString</span> *onePath <span class="keyword">in</span> keyPath) &#123;</span><br><span class="line">                    <span class="comment">// 如果存在空字符串则从数组中删除（这里也属于一个容错处理，比如 @"ext.desc."）</span></span><br><span class="line">                    <span class="keyword">if</span> (onePath.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">NSMutableArray</span> *tmp = keyPath.mutableCopy;</span><br><span class="line">                        [tmp removeObject:<span class="string">@""</span>];</span><br><span class="line">                        keyPath = tmp;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果 keyPath 数组个数大于 1，说明当前 mappedToKey 为映射的路径 e.g  @"ext.desc"</span></span><br><span class="line">                <span class="keyword">if</span> (keyPath.count &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// 赋值</span></span><br><span class="line">                    propertyMeta-&gt;_mappedToKeyPath = keyPath;</span><br><span class="line">                    [keyPathPropertyMetas addObject:propertyMeta];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/**</span><br><span class="line">                 一般一个属性名对应一个 key 值，如果多个属性名对应一个 key 值 e.g.</span><br><span class="line">                 @&#123;</span><br><span class="line">                    @"contentId":@"id",</span><br><span class="line">                    @"ID":@"id",</span><br><span class="line">                    @"categoryId":@"id"</span><br><span class="line">                    &#125;</span><br><span class="line">                 属性 contentId,ID,categoryId 都对应 id，这时候 _next 指针发挥作用</span><br><span class="line">                 首先 contentId 的 _next = nil, 将当前 contentId 相关属性信息存入 mapper 字典</span><br><span class="line">                 遍历到字典第 2 项时，ID 的 _next 指向第一个 contentId, 将 ID 相关信息存入到 mapper 字典中</span><br><span class="line">                 最后遍历到最后一项 categoryId，将 categoryId 的 _next 指向上一个 ID，并存入字典中</span><br><span class="line">                 就这样，key 保持不变，变化 value 的值，通过 _next 实现一个单链表</span><br><span class="line">                 **/</span></span><br><span class="line">                <span class="comment">// 这里 propertyMeta-&gt;_next 为 nil</span></span><br><span class="line">                propertyMeta-&gt;_next = mapper[mappedToKey] ?: <span class="literal">nil</span>;</span><br><span class="line">                <span class="comment">// 将映射的 key 和 propertyMeta 存入字典中</span></span><br><span class="line">                mapper[mappedToKey] = propertyMeta;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([mappedToKey isKindOfClass:[<span class="built_in">NSArray</span> class]]) &#123; <span class="comment">// 如果需要映射的key 是一个数组，e.g. @[@"id",@"ID",@"book_id"]，@[@"id", @"book.id"] 一个属性对应多个 key 的情况</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">NSMutableArray</span> *mappedToKeyArray = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">                <span class="comment">// 遍历数组</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">NSString</span> *oneKey <span class="keyword">in</span> ((<span class="built_in">NSArray</span> *)mappedToKey)) &#123;</span><br><span class="line">                    <span class="comment">// 如果不是字符串则跳出</span></span><br><span class="line">                    <span class="keyword">if</span> (![oneKey isKindOfClass:[<span class="built_in">NSString</span> class]]) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">if</span> (oneKey.length == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">// "." 切割字符串为数组</span></span><br><span class="line">                    <span class="built_in">NSArray</span> *keyPath = [oneKey componentsSeparatedByString:<span class="string">@"."</span>];</span><br><span class="line">                    <span class="comment">// 如果数组大于 1，则为 keyPath 路径</span></span><br><span class="line">                    <span class="keyword">if</span> (keyPath.count &gt; <span class="number">1</span>) &#123;    <span class="comment">// e.g. @""book.id"</span></span><br><span class="line">                        <span class="comment">// 将 keyPath 数组存入映射数组中</span></span><br><span class="line">                        [mappedToKeyArray addObject:keyPath]; <span class="comment">// @[@"book", @"id"]</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 将 key 存入映射数组中</span></span><br><span class="line">                        [mappedToKeyArray addObject:oneKey]; <span class="comment">// @"id"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 如果 _mappedToKey 为空</span></span><br><span class="line">                    <span class="keyword">if</span> (!propertyMeta-&gt;_mappedToKey) &#123;</span><br><span class="line">                        <span class="comment">// 赋值 e.g. @"id", @"book.id"</span></span><br><span class="line">                        propertyMeta-&gt;_mappedToKey = oneKey;</span><br><span class="line">                        <span class="comment">// 赋值 _mappedToKeyPath 数组，如果是 @"book.id",将 @[@"book", @"id"] 赋值数组，否则为 nil</span></span><br><span class="line">                        propertyMeta-&gt;_mappedToKeyPath = keyPath.count &gt; <span class="number">1</span> ? keyPath : <span class="literal">nil</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 判空</span></span><br><span class="line">                <span class="keyword">if</span> (!propertyMeta-&gt;_mappedToKey) <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">// 赋值 _mappedToKeyArray 包含 key（string），keyPath（array）</span></span><br><span class="line">                propertyMeta-&gt;_mappedToKeyArray = mappedToKeyArray;</span><br><span class="line">                <span class="comment">// add 属性一对多 key 数组</span></span><br><span class="line">                [multiKeysPropertyMetas addObject:propertyMeta];</span><br><span class="line">                <span class="comment">// 和上面一样</span></span><br><span class="line">                propertyMeta-&gt;_next = mapper[mappedToKey] ?: <span class="literal">nil</span>;</span><br><span class="line">                mapper[mappedToKey] = propertyMeta;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历 allPropertyMetas 字典</span></span><br><span class="line">    [allPropertyMetas enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *name, _YYModelPropertyMeta *propertyMeta, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="comment">// 赋值属性的 _mappedToKey 和 _next</span></span><br><span class="line">        propertyMeta-&gt;_mappedToKey = name;</span><br><span class="line">        <span class="comment">// 和上面作用一样</span></span><br><span class="line">        propertyMeta-&gt;_next = mapper[name] ?: <span class="literal">nil</span>;</span><br><span class="line">        mapper[name] = propertyMeta;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">// 赋值</span></span><br><span class="line">    <span class="keyword">if</span> (mapper.count) _mapper = mapper;</span><br><span class="line">    <span class="keyword">if</span> (keyPathPropertyMetas) _keyPathPropertyMetas = keyPathPropertyMetas;</span><br><span class="line">    <span class="keyword">if</span> (multiKeysPropertyMetas) _multiKeysPropertyMetas = multiKeysPropertyMetas;</span><br><span class="line">    </span><br><span class="line">    _classInfo = classInfo;</span><br><span class="line">    _keyMappedCount = _allPropertyMetas.count;</span><br><span class="line">    _nsType = YYClassGet<span class="built_in">NSType</span>(cls);</span><br><span class="line">    <span class="comment">// 判断是否响应各代理方法并赋值</span></span><br><span class="line">    _hasCustomWillTransformFromDictionary = ([cls instancesRespondToSelector:<span class="keyword">@selector</span>(modelCustomWillTransformFromDictionary:)]);</span><br><span class="line">    _hasCustomTransformFromDictionary = ([cls instancesRespondToSelector:<span class="keyword">@selector</span>(modelCustomTransformFromDictionary:)]);</span><br><span class="line">    _hasCustomTransformToDictionary = ([cls instancesRespondToSelector:<span class="keyword">@selector</span>(modelCustomTransformToDictionary:)]);</span><br><span class="line">    _hasCustomClassFromDictionary = ([cls respondsToSelector:<span class="keyword">@selector</span>(modelCustomClassForDictionary:)]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回缓存的 _YYModelMeta</span></span><br><span class="line">+ (instancetype)metaWithClass:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 单例创建缓存字典</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableDictionaryRef</span> cache;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="keyword">static</span> dispatch_semaphore_t lock;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        cache = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;k<span class="built_in">CFTypeDictionaryKeyCallBacks</span>, &amp;k<span class="built_in">CFTypeDictionaryValueCallBacks</span>);</span><br><span class="line">        lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 加锁保证线程安全</span></span><br><span class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="comment">// 取出缓存</span></span><br><span class="line">    _YYModelMeta *meta = <span class="built_in">CFDictionaryGetValue</span>(cache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(cls));</span><br><span class="line">    dispatch_semaphore_signal(lock);</span><br><span class="line">    <span class="comment">// 如果缓存为 nil 或者 需要更新缓存</span></span><br><span class="line">    <span class="keyword">if</span> (!meta || meta-&gt;_classInfo.needUpdate) &#123;</span><br><span class="line">        <span class="comment">// 生成 _YYModelMeta 实例</span></span><br><span class="line">        meta = [[_YYModelMeta alloc] initWithClass:cls];</span><br><span class="line">        <span class="keyword">if</span> (meta) &#123;</span><br><span class="line">            <span class="comment">// 将实例存入缓存</span></span><br><span class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">            <span class="built_in">CFDictionarySetValue</span>(cache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(cls), (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(meta));</span><br><span class="line">            dispatch_semaphore_signal(lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>metaWithClass</strong> 类方法主要是从缓存中去取实例，如果缓存没有或者需要更新，则 new 一个存入缓存中并返回。<br>这里主要说一下 <strong>initWithClass</strong> 方法，代码比较长，简单的小结一下就是：</p>
<ul>
<li>先实例化一个 <strong>YYClassInfo</strong> 对象</li>
<li>判断是否实现 <strong>modelPropertyBlacklist</strong> 方法，获取黑名单数组</li>
<li>判断是否实现 <strong>modelPropertyWhitelist</strong> 方法，获取白名单数组</li>
<li>判断是否实现 <strong>modelContainerPropertyGenericClass</strong> 方法，由于支持多个写法需要处理该字典，得到 key 不变，value 为 class 的字典 </li>
<li>通过 <strong>YYClassInfo</strong> 实例，循环解析父类，直到父类为 <strong>NSObject/NSProxy</strong>，遍历 <strong>YYClassInfo</strong> 所有的属性，忽略黑名单中的属性，忽略白名单之外的属性，实例化 <strong>_YYModelPropertyMeta</strong>， 进行各种校验加入字典，最终得到，key 为属性名，value 为 <strong>_YYModelPropertyMeta</strong> 实例的字典 <strong>allPropertyMetas</strong></li>
<li>判断是否实现 <strong>modelCustomPropertyMapper</strong> 方法，拿到对应的字典信息，遍历字典，通过字典中属性名从 <strong>allPropertyMetas</strong> 取到对应 <strong>_YYModelPropertyMeta</strong><ul>
<li>如果字典中需要映射的值是一个字符串：直接赋值 <strong>_mappedToKey</strong>，再判断当前 key 是否是 keyPath 路径，如果是将 keyPath 路径拆分成数组赋值 <strong>_mappedToKeyPath</strong>，再将对应同一个 key 的属性通过 <strong>_next</strong> 指针关联起来</li>
<li>如果字典中需要映射的值是数组：遍历数组，判断当前 key 是否是 keyPath 路径，如果是 key 直接添加到 <strong>mappedToKeyArray</strong>，是 keyPath 路径拆分成数组添加到 <strong>mappedToKeyArray</strong>，赋值 <strong>_mappedToKey</strong> （包含 key 和 keyPath 字符串），赋值 <strong>_mappedToKeyPath</strong>（存有拆分的 keyPath 数组），最后赋值给 <strong>_mappedToKeyArray</strong>，再将对应同一个 key 的属性通过 <strong>_next</strong> 指针关联起来</li>
</ul>
</li>
<li>遍历 <strong>allPropertyMetas</strong> 字典，赋值每个 <strong>_YYModelPropertyMeta</strong> 实例的 <strong>_mappedToKey</strong> 和 <strong>_next</strong></li>
<li>其他各种初始化</li>
</ul>
<h2 id="对外开放的接口"><a href="#对外开放的接口" class="headerlink" title="对外开放的接口"></a>对外开放的接口</h2><p>.h 文件一目了然，就是 YYModel 协议，NSObject，NSArray，以及 NSDictionary 3 个 category，三个分类我们从少看多开始看起</p>
<h3 id="NSArray-YYModel"><a href="#NSArray-YYModel" class="headerlink" title="NSArray (YYModel)"></a>NSArray (YYModel)</h3><p>对外只有一个 <strong>+ (nullable NSArray *)yy_modelArrayWithClass:(Class)cls json:(id)json</strong> 方法，这里关键调用了 <strong>yy_modelWithDictionary</strong> 方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// 创建返回一个 json Array</span><br><span class="line">+ (NSArray *)yy_modelArrayWithClass:(Class)cls json:(id)json &#123;</span><br><span class="line">    if (!json) return nil;</span><br><span class="line">    NSArray *arr = nil;</span><br><span class="line">    NSData *jsonData = nil;</span><br><span class="line">    // 判断 json 类型</span><br><span class="line">    if ([json isKindOfClass:[NSArray class]]) &#123; // 数组直接赋值</span><br><span class="line">        arr = json;</span><br><span class="line">    &#125; else if ([json isKindOfClass:[NSString class]]) &#123; // 字符串转成 NSData</span><br><span class="line">        jsonData = [(NSString *)json dataUsingEncoding : NSUTF8StringEncoding];</span><br><span class="line">    &#125; else if ([json isKindOfClass:[NSData class]]) &#123;   // NSData 直接赋值</span><br><span class="line">        jsonData = json;</span><br><span class="line">    &#125;</span><br><span class="line">    if (jsonData) &#123; // 这里是 if 后面 2 个判断</span><br><span class="line">        arr = [NSJSONSerialization JSONObjectWithData:jsonData options:kNilOptions error:NULL];</span><br><span class="line">        if (![arr isKindOfClass:[NSArray class]]) arr = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return [self yy_modelArrayWithClass:cls array:arr];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSArray *)yy_modelArrayWithClass:(Class)cls array:(NSArray *)arr &#123;</span><br><span class="line">    if (!cls || !arr) return nil;</span><br><span class="line">    NSMutableArray *result = [NSMutableArray new];</span><br><span class="line">    // 遍历数组</span><br><span class="line">    for (NSDictionary *dic in arr) &#123;</span><br><span class="line">        // 如果数组元素不是 dic 则跳过</span><br><span class="line">        if (![dic isKindOfClass:[NSDictionary class]]) continue;</span><br><span class="line">        // dic 转 model</span><br><span class="line">        NSObject *obj = [cls yy_modelWithDictionary:dic];</span><br><span class="line">        // model 加入到数组</span><br><span class="line">        if (obj) [result addObject:obj];</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="NSDictionary-YYModel"><a href="#NSDictionary-YYModel" class="headerlink" title="NSDictionary (YYModel)"></a>NSDictionary (YYModel)</h3><p>对外提供 <strong>+ (nullable NSDictionary *)yy_modelDictionaryWithClass:(Class)cls json:(id)json</strong> 方法<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSDictionary</span> *)yy_modelDictionaryWithClass:(Class)cls json:(<span class="keyword">id</span>)json &#123;</span><br><span class="line">    <span class="keyword">if</span> (!json) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSDictionary</span> *dic = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSData</span> *jsonData = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">        dic = json;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;</span><br><span class="line">        jsonData = [(<span class="built_in">NSString</span> *)json dataUsingEncoding : <span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSData</span> class]]) &#123;</span><br><span class="line">        jsonData = json;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (jsonData) &#123;</span><br><span class="line">        dic = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:jsonData options:kNilOptions error:<span class="literal">NULL</span>];</span><br><span class="line">        <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) dic = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> yy_modelDictionaryWithClass:cls dictionary:dic];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSDictionary</span> *)yy_modelDictionaryWithClass:(Class)cls dictionary:(<span class="built_in">NSDictionary</span> *)dic &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls || !dic) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *result = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">    <span class="comment">// 遍历字典所有的 key</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> dic.allKeys) &#123;</span><br><span class="line">        <span class="comment">// key 不是字符串则跳过</span></span><br><span class="line">        <span class="keyword">if</span> (![key isKindOfClass:[<span class="built_in">NSString</span> class]]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// 根据 key 取出 value，根据 value 设置 model</span></span><br><span class="line">        <span class="built_in">NSObject</span> *obj = [cls yy_modelWithDictionary:dic[key]];</span><br><span class="line">        <span class="comment">// key model 存入字典</span></span><br><span class="line">        <span class="keyword">if</span> (obj) result[key] = obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">```` </span><br><span class="line"></span><br><span class="line">这里可以看到还是调用关键方法 **yy_modelWithDictionary** 下面会说到</span><br><span class="line"></span><br><span class="line"><span class="meta">### NSObject (YYModel)</span></span><br><span class="line">这个分类里面的接口相对来说就比较多了，我们关注重要的，其他的就简单带过吧</span><br><span class="line">- description: **yy_modelDescription**</span><br><span class="line">- equal: **yy_modelIsEqual**</span><br><span class="line">- hash: **yy_modelHash**</span><br><span class="line">- encode: **yy_modelEncodeWithCoder**</span><br><span class="line">- decode: **yy_modelInitWithCoder**</span><br><span class="line">- <span class="keyword">copy</span>: **yy_modelCopy**</span><br><span class="line"></span><br><span class="line"><span class="meta">#### model 转 JSON 字符串</span></span><br><span class="line">````Objc</span><br><span class="line">- (<span class="built_in">NSString</span> *)yy_modelToJSO<span class="built_in">NString</span> &#123;</span><br><span class="line">    <span class="comment">// 调用 yy_modelToJSONData 获得 NSData</span></span><br><span class="line">    <span class="built_in">NSData</span> *jsonData = [<span class="keyword">self</span> yy_modelToJSONData];</span><br><span class="line">    <span class="keyword">if</span> (jsonData.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// NSData 转成 字符串</span></span><br><span class="line">    <span class="keyword">return</span> [[<span class="built_in">NSString</span> alloc] initWithData:jsonData encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="model-转-JSON-data"><a href="#model-转-JSON-data" class="headerlink" title="model 转 JSON data"></a>model 转 JSON data</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSData</span> *)yy_modelToJSONData &#123;</span><br><span class="line">    <span class="comment">// 调用 yy_modelToJSONObject 得到 JSON 对象</span></span><br><span class="line">    <span class="keyword">id</span> jsonObject = [<span class="keyword">self</span> yy_modelToJSONObject];</span><br><span class="line">    <span class="comment">// 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!jsonObject) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 通过 NSJSONSerialization 将 jsonObject 转成 NSData</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSJSONSerialization</span> dataWithJSONObject:jsonObject options:<span class="number">0</span> error:<span class="literal">NULL</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="model-转-JSON"><a href="#model-转-JSON" class="headerlink" title="model 转 JSON"></a>model 转 JSON</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)yy_modelToJSONObject &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     Apple said:</span><br><span class="line">     The top level object is an NSArray or NSDictionary.</span><br><span class="line">     All objects are instances of NSString, NSNumber, NSArray, NSDictionary, or NSNull.</span><br><span class="line">     All dictionary keys are instances of NSString.</span><br><span class="line">     Numbers are not NaN or infinity.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="comment">// 递归模型转到 JSON</span></span><br><span class="line">    <span class="keyword">id</span> jsonObject = ModelToJSONObjectRecursive(<span class="keyword">self</span>);</span><br><span class="line">    <span class="comment">// https://developer.apple.com/documentation/foundation/nsjsonserialization</span></span><br><span class="line">    <span class="comment">// JSON 对象的顶层只能是 NSArray 或者 NSDictionary</span></span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSArray</span> class]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上三个方法其实最终调用的都是 <strong>yy_modelToJSONObject</strong>，而这个方法里面其实就是 <strong>ModelToJSONObjectRecursive</strong> 这个会和其他接口在下面重点说</p>
<h2 id="JSON-和-Model-的互转"><a href="#JSON-和-Model-的互转" class="headerlink" title="JSON 和 Model 的互转"></a>JSON 和 Model 的互转</h2><h3 id="JSON-to-Model"><a href="#JSON-to-Model" class="headerlink" title="JSON to Model"></a>JSON to Model</h3><p>继续上面未说的接口开始：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)yy_modelWithJSON:(<span class="keyword">id</span>)json &#123;</span><br><span class="line">    <span class="comment">// 先将 json 转为 dict</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *dic = [<span class="keyword">self</span> _yy_dictionaryWithJSON:json];</span><br><span class="line">    <span class="comment">// dict 转 model</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> yy_modelWithDictionary:dic];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法是将 JSON 转换成 Model，内部呢又分为了 2 部分操作</p>
<ul>
<li>JSON to NSDictionary</li>
<li>NSDictionary to Model</li>
</ul>
<p>那么下面我们按照步骤来分析一下</p>
<h4 id="JSON-to-NSDictionary"><a href="#JSON-to-NSDictionary" class="headerlink" title="JSON to NSDictionary"></a>JSON to NSDictionary</h4><p>调用 <strong>_yy_dictionaryWithJSON</strong> 方法将 json 转成 dict<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSDictionary</span> *)_yy_dictionaryWithJSON:(<span class="keyword">id</span>)json &#123;</span><br><span class="line">    <span class="comment">// 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!json || json == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSDictionary</span> *dic = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSData</span> *jsonData = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 判断 json 类型做相应的操作</span></span><br><span class="line">    <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;    <span class="comment">// 如果是字典</span></span><br><span class="line">        dic = json;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123; <span class="comment">// 如果是字符串，字符串转成 NSData</span></span><br><span class="line">        jsonData = [(<span class="built_in">NSString</span> *)json dataUsingEncoding : <span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSData</span> class]]) &#123;   <span class="comment">// 如果是 NSData 直接赋值</span></span><br><span class="line">        jsonData = json;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (jsonData) &#123; <span class="comment">// if 后面 2 种情况</span></span><br><span class="line">        <span class="comment">// NSData 通过 NSJSONSerialization 转成字典</span></span><br><span class="line">        dic = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:jsonData options:kNilOptions error:<span class="literal">NULL</span>];</span><br><span class="line">        <span class="comment">// 如果不是字典返回 nil</span></span><br><span class="line">        <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) dic = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法主要就是走下参数的校验判断类型处理最终返回一个字典对象</p>
<h4 id="NSDictionary-to-Model"><a href="#NSDictionary-to-Model" class="headerlink" title="NSDictionary to Model"></a>NSDictionary to Model</h4><p>从 <strong>yy_modelWithDictionary</strong> 方法开始<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)yy_modelWithDictionary:(<span class="built_in">NSDictionary</span> *)dictionary &#123;</span><br><span class="line">    <span class="comment">// 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!dictionary || dictionary == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 判断是否为 dict</span></span><br><span class="line">    <span class="keyword">if</span> (![dictionary isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    Class cls = [<span class="keyword">self</span> class];</span><br><span class="line">    <span class="comment">// 取出当前类的模型元实例 _YYModelMeta （先从缓存拿没有则生成）</span></span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:cls];</span><br><span class="line">    <span class="comment">// 额外处理的 dict 对应 class</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">        cls = [cls modelCustomClassForDictionary:dictionary] ?: cls;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成新的实例对象</span></span><br><span class="line">    <span class="built_in">NSObject</span> *one = [cls new];</span><br><span class="line">    <span class="comment">// 调用 yy_modelSetWithDictionary 为实例复制并且返回</span></span><br><span class="line">    <span class="keyword">if</span> ([one yy_modelSetWithDictionary:dictionary]) <span class="keyword">return</span> one;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要看关键函数 <strong>yy_modelSetWithDictionary</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)yy_modelSetWithDictionary:(<span class="built_in">NSDictionary</span> *)dic &#123;</span><br><span class="line">    <span class="comment">// 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!dic || dic == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="comment">// 判断 dic 不是字典直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过自身类获取 _YYModelMeta 实例</span></span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:object_getClass(<span class="keyword">self</span>)];</span><br><span class="line">    <span class="comment">// 如果模型元类键值映射数量为 0 返回 NO</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_keyMappedCount == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="comment">// 判断是否实现 modelCustomWillTransformFromDictionary</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomWillTransformFromDictionary) &#123;</span><br><span class="line">        <span class="comment">// 获取 dict</span></span><br><span class="line">        dic = [((<span class="keyword">id</span>&lt;YYModel&gt;)<span class="keyword">self</span>) modelCustomWillTransformFromDictionary:dic];</span><br><span class="line">        <span class="comment">// 判断 dict 类型</span></span><br><span class="line">        <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化模型设置上下文</span></span><br><span class="line">    ModelSetContext context = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    context.modelMeta = (__bridge <span class="keyword">void</span> *)(modelMeta);</span><br><span class="line">    context.model = (__bridge <span class="keyword">void</span> *)(<span class="keyword">self</span>);</span><br><span class="line">    context.dictionary = (__bridge <span class="keyword">void</span> *)(dic);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断模型元键值映射数量和 json 所得数量关系，一般情况数量相等，</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_keyMappedCount &gt;= <span class="built_in">CFDictionaryGetCount</span>((<span class="built_in">CFDictionaryRef</span>)dic)) &#123; <span class="comment">// 属性元会映射字典中的多个 key</span></span><br><span class="line">        <span class="comment">// 为字典中的每一项调用 ModelSetWithDictionaryFunction 函数通过字典设置模型,context 作为另外的参数传给这个函数调用</span></span><br><span class="line">        <span class="built_in">CFDictionaryApplyFunction</span>((<span class="built_in">CFDictionaryRef</span>)dic, ModelSetWithDictionaryFunction, &amp;context);</span><br><span class="line">        <span class="keyword">if</span> (modelMeta-&gt;_keyPathPropertyMetas) &#123; <span class="comment">// 模型中存在映射 keyPath 的属性元</span></span><br><span class="line">            <span class="comment">// 为每个映射 keyPath 的属性元执行 ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">            <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_keyPathPropertyMetas,</span><br><span class="line">                                 <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_keyPathPropertyMetas)),</span><br><span class="line">                                 ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                                 &amp;context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (modelMeta-&gt;_multiKeysPropertyMetas) &#123;   <span class="comment">// 存在映射多个 key 的属性元，每个调用 ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">            <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_multiKeysPropertyMetas,</span><br><span class="line">                                 <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_multiKeysPropertyMetas)),</span><br><span class="line">                                 ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                                 &amp;context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 为每个属性元调用 ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">        <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_allPropertyMetas,</span><br><span class="line">                             <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, modelMeta-&gt;_keyMappedCount),</span><br><span class="line">                             ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                             &amp;context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomTransformFromDictionary) &#123;</span><br><span class="line">        <span class="keyword">return</span> [((<span class="keyword">id</span>&lt;YYModel&gt;)<span class="keyword">self</span>) modelCustomTransformFromDictionary:dic];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小结一下改方法的作用就是：</p>
<ul>
<li>入参校验</li>
<li>初始化模型元，对模型元映射键值数量判断</li>
<li>初始化模型设置上下文 <strong>ModelSetContext</strong></li>
<li>判断模型元中映射键值数量和 json 转成的 dict 的 数量<ul>
<li>大于等于情况（有可能多个属性映射相同的一个 key，实现了 <strong>modelCustomPropertyMapper</strong> 方法）：先为字典中的每一项调用 <strong>ModelSetWithDictionaryFunction</strong>，其次判断模型元中属性元是否存在映射 keyPath 路径的情况，有的话为模型元中 <strong>_keyPathPropertyMetas</strong> 数组的每一项调用 <strong>ModelSetWithPropertyMetaArrayFunction</strong> 方法，最后判断模型元中是否有属性元映射多个 key，有的话为 <strong>_multiKeysPropertyMetas</strong> 数组中每一项调用 <strong>ModelSetWithPropertyMetaArrayFunction</strong> 函数</li>
<li>小于的情况：为模型元中 <strong>_allPropertyMetas</strong> 每个属性元调用 <strong>ModelSetWithPropertyMetaArrayFunction</strong> 函数</li>
</ul>
</li>
</ul>
<p>首先说下 <strong>ModelSetContext</strong>，模型设置上下文，其实就是一个包含模型元，模型实例以及待转换字典的结构体。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> *modelMeta;  <span class="comment">///&lt; 模型元</span></span><br><span class="line">    <span class="keyword">void</span> *model;      <span class="comment">///&lt; 模型实例，指向输出的模型</span></span><br><span class="line">    <span class="keyword">void</span> *dictionary; <span class="comment">///&lt; 待转换字典</span></span><br><span class="line">&#125; ModelSetContext;</span><br></pre></td></tr></table></figure></p>
<p>这里的作用其实就是当使用类似 <strong>CFDictionaryApplyFunction</strong> 相关函数时，可以将多个参数传进去，在函数内使用。</p>
<p>接着我们按顺序来看 <strong>ModelSetWithDictionaryFunction</strong> 函数：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用方法吧字段中对应 key 的 value 赋值给 model</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ModelSetWithDictionaryFunction(<span class="keyword">const</span> <span class="keyword">void</span> *_key, <span class="keyword">const</span> <span class="keyword">void</span> *_value, <span class="keyword">void</span> *_context) &#123;</span><br><span class="line">    <span class="comment">// 拿到上下文</span></span><br><span class="line">    ModelSetContext *context = _context;</span><br><span class="line">    <span class="comment">// 取出上下文中的模型元</span></span><br><span class="line">    __unsafe_unretained _YYModelMeta *meta = (__bridge _YYModelMeta *)(context-&gt;modelMeta);</span><br><span class="line">    <span class="comment">// 根据 key 从模型元中得到对应的属性元</span></span><br><span class="line">    __unsafe_unretained _YYModelPropertyMeta *propertyMeta = [meta-&gt;_mapper objectForKey:(__bridge <span class="keyword">id</span>)(_key)];</span><br><span class="line">    <span class="comment">// 拿到待赋值的模型</span></span><br><span class="line">    __unsafe_unretained <span class="keyword">id</span> model = (__bridge <span class="keyword">id</span>)(context-&gt;model);</span><br><span class="line">    <span class="comment">// 遍历 propertyMeta 直到 propertyMeta-&gt;_next 为 nil</span></span><br><span class="line">    <span class="keyword">while</span> (propertyMeta) &#123;</span><br><span class="line">        <span class="comment">// 当遍历的属性元有 setter 方法的话，调用 ModelSetValueForProperty 给属性赋值</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_setter) &#123;</span><br><span class="line">            ModelSetValueForProperty(model, (__bridge __unsafe_unretained <span class="keyword">id</span>)_value, propertyMeta);</span><br><span class="line">        &#125;</span><br><span class="line">        propertyMeta = propertyMeta-&gt;_next;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们看到使用 <strong>propertyMeta-&gt;_next</strong>，还记得上面 <strong>_YYModelMeta</strong> 的 <strong>initWithClass</strong> 函数是怎么使用的嘛？为了解决多个属性映射相同一个 key 的查找问题，作者通过 <strong>_next</strong> 指针巧妙的实现了一个单链表，同时 mapper 中存的是链表最后一项的值，在这里只要判断 <strong>propertyMeta</strong> 不为 nil，并且将它的指针不断前移，就可以遍历映射同一个 key 的所有属性了。然后拿到 value 和属性元就是一个个赋值调用 <strong>ModelSetValueForProperty</strong> 函数</p>
<p><strong>ModelSetValueForProperty</strong>:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ModelSetValueForProperty(__unsafe_unretained <span class="keyword">id</span> model,</span><br><span class="line">                                     __unsafe_unretained <span class="keyword">id</span> value,</span><br><span class="line">                                     __unsafe_unretained _YYModelPropertyMeta *meta) &#123;</span><br><span class="line">    <span class="comment">// 如果属性是 C number e.g. int...</span></span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;_isCNumber) &#123;</span><br><span class="line">        <span class="comment">// 先将 value 转为 Number</span></span><br><span class="line">        <span class="built_in">NSNumber</span> *num = YY<span class="built_in">NSNumberCreateFromID</span>(value);</span><br><span class="line">        <span class="comment">// 然后将 Number 赋值</span></span><br><span class="line">        ModelSetNumberToProperty(model, num, meta);</span><br><span class="line">        <span class="keyword">if</span> (num != <span class="literal">nil</span>) [num class]; <span class="comment">// hold the number</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta-&gt;_nsType) &#123; <span class="comment">// 如果属性是 Foundation 类型 e.g. NSString...</span></span><br><span class="line">        <span class="keyword">if</span> (value == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) &#123; <span class="comment">// 为空，则赋值 nil</span></span><br><span class="line">            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (<span class="keyword">id</span>)<span class="literal">nil</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 不为空</span></span><br><span class="line">            <span class="keyword">switch</span> (meta-&gt;_nsType) &#123;</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSString</span>:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSMutableString</span>: &#123;   <span class="comment">// _nsType 为 NSString 或者 NSMutableString，对应的 value 有多种情况 NSString, NSNumber, NSData, NSURL, NSAttributedString, 对应分支就是将 value 转为 NSString 或者 NSMutableString</span></span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSString</span>) &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, ((<span class="built_in">NSString</span> *)value).mutableCopy);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSNumber</span> class]]) &#123;</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model,</span><br><span class="line">                                                                       meta-&gt;_setter,</span><br><span class="line">                                                                       (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSString</span>) ?</span><br><span class="line">                                                                       ((<span class="built_in">NSNumber</span> *)value).stringValue :</span><br><span class="line">                                                                       ((<span class="built_in">NSNumber</span> *)value).stringValue.mutableCopy);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSData</span> class]]) &#123;</span><br><span class="line">                        <span class="built_in">NSMutableString</span> *string = [[<span class="built_in">NSMutableString</span> alloc] initWithData:value encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, string);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSURL</span> class]]) &#123;</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model,</span><br><span class="line">                                                                       meta-&gt;_setter,</span><br><span class="line">                                                                       (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSString</span>) ?</span><br><span class="line">                                                                       ((<span class="built_in">NSURL</span> *)value).absoluteString :</span><br><span class="line">                                                                       ((<span class="built_in">NSURL</span> *)value).absoluteString.mutableCopy);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSAttributedString</span> class]]) &#123;</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model,</span><br><span class="line">                                                                       meta-&gt;_setter,</span><br><span class="line">                                                                       (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSString</span>) ?</span><br><span class="line">                                                                       ((<span class="built_in">NSAttributedString</span> *)value).string :</span><br><span class="line">                                                                       ((<span class="built_in">NSAttributedString</span> *)value).string.mutableCopy);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSValue</span>:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSNumber</span>:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSDecimalNumber</span>: &#123;</span><br><span class="line">                    <span class="comment">// _nsType 对应为 NSValue, NSNumber, NSDecimalNumber 情况下</span></span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSNumber</span>) &#123;</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, YY<span class="built_in">NSNumberCreateFromID</span>(value));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSDecimalNumber</span>) &#123;</span><br><span class="line">                        <span class="comment">// 对于 value 可能为 NSDecimalNumber, NSNumber, NSString 对应的进行转换</span></span><br><span class="line">                        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDecimalNumber</span> class]]) &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSNumber</span> class]]) &#123;</span><br><span class="line">                            <span class="built_in">NSDecimalNumber</span> *decNum = [<span class="built_in">NSDecimalNumber</span> decimalNumberWithDecimal:[((<span class="built_in">NSNumber</span> *)value) decimalValue]];</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, decNum);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;</span><br><span class="line">                            <span class="built_in">NSDecimalNumber</span> *decNum = [<span class="built_in">NSDecimalNumber</span> decimalNumberWithString:value];</span><br><span class="line">                            <span class="built_in">NSDecimal</span> dec = decNum.decimalValue;</span><br><span class="line">                            <span class="keyword">if</span> (dec._length == <span class="number">0</span> &amp;&amp; dec._isNegative) &#123;</span><br><span class="line">                                decNum = <span class="literal">nil</span>; <span class="comment">// NaN</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, decNum);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// YYEncodingTypeNSValue</span></span><br><span class="line">                        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSValue</span> class]]) &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSData</span>:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSMutableData</span>: &#123;</span><br><span class="line">                    <span class="comment">// _nsType 为 NSData 或者 NSMutableData</span></span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSData</span> class]]) &#123;</span><br><span class="line">                        <span class="comment">// value 为 NSData 时，根据 type 直接设置还是转换后再设置</span></span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSData</span>) &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="built_in">NSMutableData</span> *data = ((<span class="built_in">NSData</span> *)value).mutableCopy;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, data);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;</span><br><span class="line">                        <span class="comment">// value 为字符串的时候，进行转换再设置</span></span><br><span class="line">                        <span class="built_in">NSData</span> *data = [(<span class="built_in">NSString</span> *)value dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSMutableData</span>) &#123;</span><br><span class="line">                            data = ((<span class="built_in">NSData</span> *)data).mutableCopy;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, data);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSDate</span>: &#123;    <span class="comment">// _nsType 为 NSDate</span></span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDate</span> class]]) &#123; <span class="comment">// value 为 NSDate 直接设置</span></span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123; <span class="comment">// value 为字符串，通过工具方法转换成 NSDate 后设置，支持多种格式的日期</span></span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, YY<span class="built_in">NSDateFromString</span>(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSURL</span>: &#123; <span class="comment">// _nsType 为 NSURL</span></span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSURL</span> class]]) &#123; <span class="comment">// 直接设置</span></span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123; <span class="comment">// value 为 NSString 进行转换设置</span></span><br><span class="line">                        <span class="built_in">NSCharacterSet</span> *set = [<span class="built_in">NSCharacterSet</span> whitespaceAndNewlineCharacterSet];</span><br><span class="line">                        <span class="comment">// 去除空格</span></span><br><span class="line">                        <span class="built_in">NSString</span> *str = [value stringByTrimmingCharactersInSet:set];</span><br><span class="line">                        <span class="comment">// 字符长度为 0 设为 nil</span></span><br><span class="line">                        <span class="keyword">if</span> (str.length == <span class="number">0</span>) &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, <span class="literal">nil</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, [[<span class="built_in">NSURL</span> alloc] initWithString:str]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSArray</span>:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSMutableArray</span>: &#123; <span class="comment">// _nsType 为 NSArray, NSMutableArray</span></span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_genericCls) &#123;    <span class="comment">// 如果有泛型 NSArray&lt;Model *&gt;</span></span><br><span class="line">                        <span class="built_in">NSArray</span> *valueArr = <span class="literal">nil</span>;</span><br><span class="line">                        <span class="comment">// 类型判断，value 为 NSArray 直接赋值，为 NSSet 则转为 NSArray 赋值</span></span><br><span class="line">                        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> class]]) valueArr = value;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> class]]) valueArr = ((<span class="built_in">NSSet</span> *)value).allObjects;</span><br><span class="line">                        <span class="keyword">if</span> (valueArr) &#123;</span><br><span class="line">                            <span class="built_in">NSMutableArray</span> *objectArr = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">                            <span class="comment">// 遍历 valueArr</span></span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">id</span> one <span class="keyword">in</span> valueArr) &#123;</span><br><span class="line">                                <span class="comment">// 如果数组元素是对应的泛型类，则直接加入 objectArr</span></span><br><span class="line">                                <span class="keyword">if</span> ([one isKindOfClass:meta-&gt;_genericCls]) &#123;</span><br><span class="line">                                    [objectArr addObject:one];</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([one isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">                                    <span class="comment">// 如果数组元素是字典，先获取对应的泛型类</span></span><br><span class="line">                                    Class cls = meta-&gt;_genericCls;</span><br><span class="line">                                    <span class="comment">// 如果有实现自定义指定 key 对应的类型方法</span></span><br><span class="line">                                    <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                                        <span class="comment">// 取出指定的 class</span></span><br><span class="line">                                        cls = [cls modelCustomClassForDictionary:one];</span><br><span class="line">                                        <span class="keyword">if</span> (!cls) cls = meta-&gt;_genericCls; <span class="comment">// for xcode code coverage</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="comment">// </span></span><br><span class="line">                                    <span class="built_in">NSObject</span> *newOne = [cls new];</span><br><span class="line">                                    [newOne yy_modelSetWithDictionary:one];</span><br><span class="line">                                    <span class="keyword">if</span> (newOne) [objectArr addObject:newOne];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 最后将得到的 objectArr 赋值给属性</span></span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, objectArr);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 没有指定泛型</span></span><br><span class="line">                        <span class="comment">// value 可能是 NSArray 或者 NSSet, 分别判断直接复赋值，还是转换再赋值 NSArray,NSMutableArray</span></span><br><span class="line">                        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> class]]) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSArray</span>) &#123;</span><br><span class="line">                                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model,</span><br><span class="line">                                                                               meta-&gt;_setter,</span><br><span class="line">                                                                               ((<span class="built_in">NSArray</span> *)value).mutableCopy);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> class]]) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSArray</span>) &#123;</span><br><span class="line">                                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, ((<span class="built_in">NSSet</span> *)value).allObjects);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model,</span><br><span class="line">                                                                               meta-&gt;_setter,</span><br><span class="line">                                                                               ((<span class="built_in">NSSet</span> *)value).allObjects.mutableCopy);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSDictionary</span>:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSMutableDictionary</span>: &#123;</span><br><span class="line">                    <span class="comment">// _nsType 为 NSDictionary 或者 NSMutableDictionary</span></span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">                        <span class="comment">// value 为 NSDictionary</span></span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_genericCls) &#123;    <span class="comment">// 如果有泛型</span></span><br><span class="line">                            <span class="built_in">NSMutableDictionary</span> *dic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">                            <span class="comment">// 遍历 value 字典</span></span><br><span class="line">                            [((<span class="built_in">NSDictionary</span> *)value) enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *oneKey, <span class="keyword">id</span> oneValue, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">                                <span class="comment">// 如果字典中的值为字典，即t嵌套字典情况</span></span><br><span class="line">                                <span class="keyword">if</span> ([oneValue isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">                                    <span class="comment">// 获取字典对应的类转换并存入 dict 中</span></span><br><span class="line">                                    Class cls = meta-&gt;_genericCls;</span><br><span class="line">                                    <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                                        cls = [cls modelCustomClassForDictionary:oneValue];</span><br><span class="line">                                        <span class="keyword">if</span> (!cls) cls = meta-&gt;_genericCls; <span class="comment">// for xcode code coverage</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="built_in">NSObject</span> *newOne = [cls new];</span><br><span class="line">                                    [newOne yy_modelSetWithDictionary:(<span class="keyword">id</span>)oneValue];</span><br><span class="line">                                    <span class="keyword">if</span> (newOne) dic[oneKey] = newOne;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;];</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, dic);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 没有泛型</span></span><br><span class="line">                            <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSDictionary</span>) &#123;</span><br><span class="line">                                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, value);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model,</span><br><span class="line">                                                                               meta-&gt;_setter,</span><br><span class="line">                                                                               ((<span class="built_in">NSDictionary</span> *)value).mutableCopy);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSSet</span>:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingType<span class="built_in">NSMutableSet</span>: &#123;</span><br><span class="line">                    <span class="comment">// NSSet 或者 NSMutableSet</span></span><br><span class="line">                    <span class="comment">// 判断 value 类型进行转换</span></span><br><span class="line">                    <span class="built_in">NSSet</span> *valueSet = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> class]]) valueSet = [<span class="built_in">NSMutableSet</span> setWithArray:value];</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> class]]) valueSet = ((<span class="built_in">NSSet</span> *)value);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_genericCls) &#123;    <span class="comment">// 包含泛型</span></span><br><span class="line">                        <span class="built_in">NSMutableSet</span> *set = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">                        <span class="comment">// 遍历 valueSet</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">id</span> one <span class="keyword">in</span> valueSet) &#123;</span><br><span class="line">                            <span class="keyword">if</span> ([one isKindOfClass:meta-&gt;_genericCls]) &#123; <span class="comment">// 如果元素本身是泛型类直接添加到 set</span></span><br><span class="line">                                [set addObject:one];</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([one isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">                                <span class="comment">// 如果是字典</span></span><br><span class="line">                                Class cls = meta-&gt;_genericCls;</span><br><span class="line">                                <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                                    cls = [cls modelCustomClassForDictionary:one];</span><br><span class="line">                                    <span class="keyword">if</span> (!cls) cls = meta-&gt;_genericCls; <span class="comment">// for xcode code coverage</span></span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="built_in">NSObject</span> *newOne = [cls new];</span><br><span class="line">                                [newOne yy_modelSetWithDictionary:one];</span><br><span class="line">                                <span class="keyword">if</span> (newOne) [set addObject:newOne];</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, set);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 不包含泛型</span></span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_nsType == YYEncodingType<span class="built_in">NSSet</span>) &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, valueSet);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model,</span><br><span class="line">                                                                           meta-&gt;_setter,</span><br><span class="line">                                                                           ((<span class="built_in">NSSet</span> *)valueSet).mutableCopy);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="comment">// break; commented for code coverage in next line</span></span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 既不是 C Number 也不是 Foundation 类型</span></span><br><span class="line">        <span class="built_in">BOOL</span> isNull = (value == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>);</span><br><span class="line">        <span class="keyword">switch</span> (meta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">                <span class="comment">// id</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                Class cls = meta-&gt;_genericCls ?: meta-&gt;_cls;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// value 为空直接复制 nil</span></span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (<span class="keyword">id</span>)<span class="literal">nil</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:cls] || !cls) &#123; <span class="comment">// 属性和 value 同属一个类直接赋值</span></span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (<span class="keyword">id</span>)value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123; <span class="comment">// value 为字典</span></span><br><span class="line">                    <span class="built_in">NSObject</span> *one = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="comment">// 如果属性有 getter 方法，通过 getter 方法获取到实例</span></span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_getter) &#123;</span><br><span class="line">                        one = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_getter);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (one) &#123;</span><br><span class="line">                        <span class="comment">// 用 yy_modelSetWithDictionary 输出属性实例对象</span></span><br><span class="line">                        [one yy_modelSetWithDictionary:value];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                            cls = [cls modelCustomClassForDictionary:value] ?: cls;</span><br><span class="line">                        &#125;</span><br><span class="line">                        one = [cls new];</span><br><span class="line">                        [one yy_modelSetWithDictionary:value];</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (<span class="keyword">id</span>)one);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// Class</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123;   <span class="comment">// 为空则赋值 NULL</span></span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, Class))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (Class)<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Class cls = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123; <span class="comment">// value 为字符串，转成 Class 然后赋值</span></span><br><span class="line">                        cls = <span class="built_in">NSClassFromString</span>(value);</span><br><span class="line">                        <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">                            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, Class))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (Class)cls);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cls = object_getClass(value);</span><br><span class="line">                        <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (class_isMetaClass(cls)) &#123;</span><br><span class="line">                                <span class="comment">// 判断满足 class_isMetaClass(object_getClass(value)) 赋值</span></span><br><span class="line">                                ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, Class))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (Class)value);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// SEL</span></span><br><span class="line">            <span class="keyword">case</span>  YYEncodingTypeSEL: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// 为空复制 NULL</span></span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (SEL)<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123; <span class="comment">// 如果是 value 是字符串，转换成 SEL 后赋值</span></span><br><span class="line">                    SEL sel = <span class="built_in">NSSelectorFromString</span>(value);</span><br><span class="line">                    <span class="keyword">if</span> (sel) ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (SEL)sel);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// Block</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeBlock: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// 为空赋值 NULL</span></span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">void</span> (^)(<span class="keyword">void</span>)))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (<span class="keyword">void</span> (^)(<span class="keyword">void</span>))<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:YY<span class="built_in">NSBlockClass</span>()]) &#123; <span class="comment">// 如果 value 类型是 NSBlock 赋值</span></span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">void</span> (^)(<span class="keyword">void</span>)))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (<span class="keyword">void</span> (^)(<span class="keyword">void</span>))value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeStruct:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeUnion:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingType<span class="built_in">CArray</span>: &#123; <span class="comment">// struct, union, char[n]</span></span><br><span class="line">                <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSValue</span> class]]) &#123; <span class="comment">// 如果是 NSValue</span></span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">char</span> *valueType = ((<span class="built_in">NSValue</span> *)value).objCType;</span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">char</span> *metaType = meta-&gt;_info.typeEncoding.UTF8String;</span><br><span class="line">                    <span class="keyword">if</span> (valueType &amp;&amp; metaType &amp;&amp; strcmp(valueType, metaType) == <span class="number">0</span>) &#123;</span><br><span class="line">                        [model setValue:value forKey:meta-&gt;_name];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypePointer:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeCString: &#123;   <span class="comment">// void*, char*</span></span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123;</span><br><span class="line">                    ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">void</span> *))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, (<span class="keyword">void</span> *)<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSValue</span> class]]) &#123;</span><br><span class="line">                    <span class="built_in">NSValue</span> *nsValue = value;</span><br><span class="line">                    <span class="keyword">if</span> (nsValue.objCType &amp;&amp; strcmp(nsValue.objCType, <span class="string">"^v"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">void</span> *))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, meta-&gt;_setter, nsValue.pointerValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="comment">// break; commented for code coverage in next line</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法是真的长啊。。。但是逻辑确实很简单的，根据编码类型分别做相应的操作最后给属性赋值</p>
<ul>
<li>如果属性元是 C Number (int,float…) 之类的，调用 <strong>YYNSNumberCreateFromID</strong> 将 id 类型的 value 转成 NSNumber，再调用 <strong>ModelSetNumberToProperty</strong> 该函数作用就是根据属性类型做相应转换再调用 setter 方法赋值</li>
<li>如果属性元是 NSType (NSString, NSNumber…) 之类的，根据类型判断，再根据 value 对应类型做相应的转换最后赋值，如果涉及到集合，还需要判断是否有泛型，最后调用 <strong>yy_modelSetWithDictionary</strong> 给集合类里赋值</li>
<li>如果属性元既不是 C Number，也不是 NSType，则判断是否为 为 id，Class，SEL，Block，struct、union、char[n]，void<em> 或 char</em> 类型并且做出相应的转换和赋值</li>
</ul>
<p>最后我们再回到 <strong>yy_modelSetWithDictionary</strong> 函数中来看，还有一个 <strong>ModelSetWithPropertyMetaArrayFunction</strong> 函数没说：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用方法将字典转成模型</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ModelSetWithPropertyMetaArrayFunction(<span class="keyword">const</span> <span class="keyword">void</span> *_propertyMeta, <span class="keyword">void</span> *_context) &#123;</span><br><span class="line">    <span class="comment">// 拿到上下文</span></span><br><span class="line">    ModelSetContext *context = _context;</span><br><span class="line">    <span class="comment">// 拿到上下文中的 json 格式字典</span></span><br><span class="line">    __unsafe_unretained <span class="built_in">NSDictionary</span> *dictionary = (__bridge <span class="built_in">NSDictionary</span> *)(context-&gt;dictionary);</span><br><span class="line">    <span class="comment">// 入参 _propertyMeta 转为属性元</span></span><br><span class="line">    __unsafe_unretained _YYModelPropertyMeta *propertyMeta = (__bridge _YYModelPropertyMeta *)(_propertyMeta);</span><br><span class="line">    <span class="comment">// 如果属性元没有 setter 方法直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!propertyMeta-&gt;_setter) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyArray) &#123;</span><br><span class="line">        <span class="comment">// json 字典中找出能匹配的 value 值 _mappedToKeyArray 数组元素为 字符串 key，或者是 keyPath 拆分的数组</span></span><br><span class="line">        value = YYValueForMultiKeys(dictionary, propertyMeta-&gt;_mappedToKeyArray);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyPath) &#123;</span><br><span class="line">        <span class="comment">// 从字典中找出匹配 keyPtah 路径的 value</span></span><br><span class="line">        value = YYValueForKeyPath(dictionary, propertyMeta-&gt;_mappedToKeyPath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 从字典中直接取出映射的 key 对应的 value</span></span><br><span class="line">        value = [dictionary objectForKey:propertyMeta-&gt;_mappedToKey];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (value) &#123; <span class="comment">// 如果能找到映射的 key 对应的 value</span></span><br><span class="line">        <span class="comment">// 从上下文中取出模型</span></span><br><span class="line">        __unsafe_unretained <span class="keyword">id</span> model = (__bridge <span class="keyword">id</span>)(context-&gt;model);</span><br><span class="line">        <span class="comment">// 给模型属性赋值</span></span><br><span class="line">        ModelSetValueForProperty(model, value, propertyMeta);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>YYValueForMultiKeys</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从字典中找出 key 或者 keyPath 对应的 value</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="keyword">id</span> YYValueForMultiKeys(__unsafe_unretained <span class="built_in">NSDictionary</span> *dic, __unsafe_unretained <span class="built_in">NSArray</span> *multiKeys) &#123;</span><br><span class="line">    <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 遍历数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> multiKeys) &#123;</span><br><span class="line">        <span class="comment">// 如果是字符串，为单纯的 key，直接取值</span></span><br><span class="line">        <span class="keyword">if</span> ([key isKindOfClass:[<span class="built_in">NSString</span> class]]) &#123;</span><br><span class="line">            value = dic[key];</span><br><span class="line">            <span class="keyword">if</span> (value) <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 这里为数组（keyPath 拆分得来）调用 YYValueForKeyPath</span></span><br><span class="line">            value = YYValueForKeyPath(dic, (<span class="built_in">NSArray</span> *)key);</span><br><span class="line">            <span class="keyword">if</span> (value) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>YYValueForKeyPath</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从字典中根据 keyPath 取出 value（将 keyPath 比如 school.class.student 切割成数组 keyPaths，然后取出对应的值）</span></span><br><span class="line"><span class="keyword">static</span> force_inline <span class="keyword">id</span> YYValueForKeyPath(__unsafe_unretained <span class="built_in">NSDictionary</span> *dic, __unsafe_unretained <span class="built_in">NSArray</span> *keyPaths) &#123;</span><br><span class="line">    <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = keyPaths.count; i &lt; max; i++) &#123;</span><br><span class="line">        <span class="comment">// 取出 key 对应 value</span></span><br><span class="line">        value = dic[keyPaths[i]];</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> &lt; max) &#123;</span><br><span class="line">            <span class="comment">// 如果 value 是字典则将当前 value 赋给字典，接下来去取这个字典中的 value （字典套字典）</span></span><br><span class="line">            <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">                dic = value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>emmmmmm，代码太长了最后小结一下：<br><img src="/images/15586842468911.jpg" alt="-w672"></p>
<h3 id="Model-to-JSON"><a href="#Model-to-JSON" class="headerlink" title="Model to JSON"></a>Model to JSON</h3><p>相比于 JSON to Model 来说，Model to JSON 更简单一些。其中因为 NSJSONSerialization 在对 JSON 的转换时做了一些规定：</p>
<ul>
<li>顶级对象是 NSArray 或者 NSDictionary 类型</li>
<li>所有的对象都是 NSString, NSNumber, NSArray, NSDictionary, 或 NSNull 的实例</li>
<li>所有字典中的 key 都是一个 NSString 实例</li>
<li>Numbers 是除去无穷大和 NaN 的其他表示</li>
</ul>
<p>找到入口方法 <strong>yy_modelToJSONObject</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// model 转 JSON</span></span><br><span class="line">- (<span class="keyword">id</span>)yy_modelToJSONObject &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     Apple said:</span><br><span class="line">     The top level object is an NSArray or NSDictionary.</span><br><span class="line">     All objects are instances of NSString, NSNumber, NSArray, NSDictionary, or NSNull.</span><br><span class="line">     All dictionary keys are instances of NSString.</span><br><span class="line">     Numbers are not NaN or infinity.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="comment">// 递归模型转到 JSON</span></span><br><span class="line">    <span class="keyword">id</span> jsonObject = ModelToJSONObjectRecursive(<span class="keyword">self</span>);</span><br><span class="line">    <span class="comment">// https://developer.apple.com/documentation/foundation/nsjsonserialization</span></span><br><span class="line">    <span class="comment">// JSON 对象的顶层只能是 NSArray 或者 NSDictionary</span></span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSArray</span> class]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实这里最主要的就是 <strong>ModelToJSONObjectRecursive</strong> 方法，而且上文也已经提到这个方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> ModelToJSONObjectRecursive(<span class="built_in">NSObject</span> *model) &#123;</span><br><span class="line">    <span class="comment">// 判空</span></span><br><span class="line">    <span class="keyword">if</span> (!model || model == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="comment">// 如果是 NSString 或者 NSNumber 直接返回</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSString</span> class]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSNumber</span> class]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="comment">// 如果是 NSDictionary</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">        <span class="comment">// 如果可以直接转换成 JSON 数据则直接返回</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:model]) <span class="keyword">return</span> model;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *newDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        <span class="comment">// 遍历字典</span></span><br><span class="line">        [((<span class="built_in">NSDictionary</span> *)model) enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> obj, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="comment">// 拿到字符串 key</span></span><br><span class="line">            <span class="built_in">NSString</span> *stringKey = [key isKindOfClass:[<span class="built_in">NSString</span> class]] ? key : key.description;</span><br><span class="line">            <span class="keyword">if</span> (!stringKey) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">// 递归解析 value</span></span><br><span class="line">            <span class="keyword">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">            <span class="keyword">if</span> (!jsonObj) jsonObj = (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>;</span><br><span class="line">            <span class="comment">// 存入到字典返回</span></span><br><span class="line">            newDic[stringKey] = jsonObj;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="keyword">return</span> newDic;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是 NSSet</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSSet</span> class]]) &#123;</span><br><span class="line">        <span class="comment">// NSSet 转 NSArray</span></span><br><span class="line">        <span class="built_in">NSArray</span> *array = ((<span class="built_in">NSSet</span> *)model).allObjects;</span><br><span class="line">        <span class="comment">// 判断 array 是否可以直接转成 JSON data, 满足的话直接返回</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:array]) <span class="keyword">return</span> array;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *newArray = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">        <span class="comment">// 遍历 array</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> array) &#123;</span><br><span class="line">            <span class="comment">// obj 如果 是 NSString 或者 NSNumber 直接添加到数组中</span></span><br><span class="line">            <span class="keyword">if</span> ([obj isKindOfClass:[<span class="built_in">NSString</span> class]] || [obj isKindOfClass:[<span class="built_in">NSNumber</span> class]]) &#123;</span><br><span class="line">                [newArray addObject:obj];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则递归解析 value 判空然后添加到数组中</span></span><br><span class="line">                <span class="keyword">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">                <span class="keyword">if</span> (jsonObj &amp;&amp; jsonObj != (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) [newArray addObject:jsonObj];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newArray;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是 NSArray</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSArray</span> class]]) &#123;</span><br><span class="line">        <span class="comment">// 本身满足可以转换成 JSON data 直接返回</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:model]) <span class="keyword">return</span> model;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *newArray = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">        <span class="comment">// 遍历 array</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> (<span class="built_in">NSArray</span> *)model) &#123;</span><br><span class="line">            <span class="comment">// obj 如果 是 NSString 或者 NSNumber 直接添加到数组中</span></span><br><span class="line">            <span class="keyword">if</span> ([obj isKindOfClass:[<span class="built_in">NSString</span> class]] || [obj isKindOfClass:[<span class="built_in">NSNumber</span> class]]) &#123;</span><br><span class="line">                [newArray addObject:obj];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则递归解析 value 判空然后添加到数组中</span></span><br><span class="line">                <span class="keyword">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">                <span class="keyword">if</span> (jsonObj &amp;&amp; jsonObj != (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) [newArray addObject:jsonObj];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newArray;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是 NSURL, 返回字符串类型数据</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSURL</span> class]]) <span class="keyword">return</span> ((<span class="built_in">NSURL</span> *)model).absoluteString;</span><br><span class="line">    <span class="comment">// 如果是 NSAttributedString 返回对应的字符串数据</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSAttributedString</span> class]]) <span class="keyword">return</span> ((<span class="built_in">NSAttributedString</span> *)model).string;</span><br><span class="line">    <span class="comment">// 如果 NSDate, 转换成 ISO 格式的日期字符串返回</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDate</span> class]]) <span class="keyword">return</span> [YYISODateFormatter() stringFromDate:(<span class="keyword">id</span>)model];</span><br><span class="line">    <span class="comment">// 如果是 NSData, 则返回 nil</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSData</span> class]]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用 metaWithClass 从缓存中取出 _YYModelMeta （该方法如果取不到缓存会实例一个存入缓存中）</span></span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:[model class]];</span><br><span class="line">    <span class="comment">// _YYModelMeta 为 nil 或者映射表为空则返回 nil</span></span><br><span class="line">    <span class="keyword">if</span> (!modelMeta || modelMeta-&gt;_keyMappedCount == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *result = [[<span class="built_in">NSMutableDictionary</span> alloc] initWithCapacity:<span class="number">64</span>];</span><br><span class="line">    <span class="comment">// 性能优化 使用 __unsafe_unretained 修饰，避免在 block 中不必要的 retain 和 release 开销</span></span><br><span class="line">    __unsafe_unretained <span class="built_in">NSMutableDictionary</span> *dic = result; <span class="comment">// avoid retain and release in block</span></span><br><span class="line">    <span class="comment">// 遍历映射表</span></span><br><span class="line">    [modelMeta-&gt;_mapper enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *propertyMappedKey, _YYModelPropertyMeta *propertyMeta, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="comment">// 当前属性没有 getter 方法则直接跳过</span></span><br><span class="line">        <span class="keyword">if</span> (!propertyMeta-&gt;_getter) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_isCNumber) &#123; <span class="comment">// 属性元是 C number，type 为 int， float 之类</span></span><br><span class="line">            <span class="comment">// 利用 getter 方法拿到对应的 NSNumber</span></span><br><span class="line">            value = ModelCreateNumberFromProperty(model, propertyMeta);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyMeta-&gt;_nsType) &#123; <span class="comment">// 属性元是 Foundation 类型, NSString 之类</span></span><br><span class="line">            <span class="comment">// 利用 getter 方法拿到 value</span></span><br><span class="line">            <span class="keyword">id</span> v = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_getter);</span><br><span class="line">            <span class="comment">// 对 value 递归解析</span></span><br><span class="line">            value = ModelToJSONObjectRecursive(v);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 既不是 C Number 也不是 NSString 之类</span></span><br><span class="line">            <span class="keyword">switch</span> (propertyMeta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">                    <span class="comment">// id</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                    <span class="comment">// getter 取值</span></span><br><span class="line">                    <span class="keyword">id</span> v = ((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_getter);</span><br><span class="line">                    <span class="comment">// 递归解析 value</span></span><br><span class="line">                    value = ModelToJSONObjectRecursive(v);</span><br><span class="line">                    <span class="comment">// 如果是 KCFNull 直接返回 nil</span></span><br><span class="line">                    <span class="keyword">if</span> (value == (<span class="keyword">id</span>)k<span class="built_in">CFNull</span>) value = <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// class</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                    <span class="comment">// getter 取值</span></span><br><span class="line">                    Class v = ((Class (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_getter);</span><br><span class="line">                    <span class="comment">// class 转字符串或者为 nil</span></span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromClass</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// SEL</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeSEL: &#123;</span><br><span class="line">                    <span class="comment">// getter 取值</span></span><br><span class="line">                    SEL v = ((SEL (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *) objc_msgSend)((<span class="keyword">id</span>)model, propertyMeta-&gt;_getter);</span><br><span class="line">                    <span class="comment">// SEL 转字符串或者为 nil</span></span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromSelector</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果 value 还是为 nil 直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!value) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 当前属性元映射的为 keyPath 路径 e.g. school.student, _mappedToKeyPath 为 keyPath 分割出来的数组</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyPath) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *superDic = dic;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *subDic = <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// 遍历 _mappedToKeyPath</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = propertyMeta-&gt;_mappedToKeyPath.count; i &lt; max; i++) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *key = propertyMeta-&gt;_mappedToKeyPath[i];</span><br><span class="line">                <span class="comment">// 遍历到数组最后一项，即 keyPath 路径最后一个</span></span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span> == max) &#123; <span class="comment">// end</span></span><br><span class="line">                    <span class="keyword">if</span> (!superDic[key]) superDic[key] = value;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 从 superDict 取出 key 对应的 value</span></span><br><span class="line">                subDic = superDic[key];</span><br><span class="line">                <span class="keyword">if</span> (subDic) &#123;   <span class="comment">// subDict 不为 nil</span></span><br><span class="line">                    <span class="keyword">if</span> ([subDic isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;  <span class="comment">// subDict 是 NSDictionary</span></span><br><span class="line">                        subDic = subDic.mutableCopy;    <span class="comment">// dict 的 mutable 版本赋值给 subDict</span></span><br><span class="line">                        superDic[key] = subDic; <span class="comment">// 将 key 和 subDict 存入到 superDict</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// subDict 为 nil</span></span><br><span class="line">                    <span class="comment">// 实例化 NSMutableDictionary 并且赋值给 superDic</span></span><br><span class="line">                    subDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">                    superDic[key] = subDic;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// superDict 指向 subDict，subDict 置为 nil，这样就可以逐层解析 </span></span><br><span class="line">                superDic = subDic;</span><br><span class="line">                subDic = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不是 _mappedToKeyPath 检测 dic[propertyMeta-&gt;_mappedToKey] 是否为空，为空则赋值 value</span></span><br><span class="line">            <span class="keyword">if</span> (!dic[propertyMeta-&gt;_mappedToKey]) &#123;</span><br><span class="line">                dic[propertyMeta-&gt;_mappedToKey] = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">// 如果有实现自定义转换接口</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomTransformToDictionary) &#123;</span><br><span class="line">        <span class="comment">// 用于在默认的 model 转 JSON 不满足时提供自定义处理</span></span><br><span class="line">        <span class="built_in">BOOL</span> suc = [((<span class="keyword">id</span>&lt;YYModel&gt;)model) modelCustomTransformToDictionary:dic];</span><br><span class="line">        <span class="comment">// 如果失败则返回 nil</span></span><br><span class="line">        <span class="keyword">if</span> (!suc) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法就是不断的递归解析，小结一下过程就是：</p>
<ul>
<li>判断 model 类型，如果满足条件则直接可以返回</li>
<li>有的 model 类型需要做转换然后返回</li>
<li>对于集合类的类型，需要做相应的判断处理或者递归解析</li>
<li>以上都不满足的话，需要从缓存中取出 <strong>_YYModelMeta</strong> 实例，判断模型元的映射关系，遍历映射表拿到对应键值对并存入字典中并返回</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，<strong>YYModel</strong> 的源码分析已经完了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/puppet_master/article/details/48550393" target="_blank" rel="external">C++那些细节–inline关键字</a><br><a href="https://juejin.im/post/5a1296e36fb9a044fb075d5e" target="_blank" rel="external">揭秘 YYModel 的魔法（下）</a><br><a href="https://developer.apple.com/documentation/foundation/nsjsonserialization" target="_blank" rel="external">NSJSONSerialization 官方文档</a><br><a href="https://github.com/ibireme/YYModel" target="_blank" rel="external">YYModel github</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2019/05/24/《YYModel 源码解析（二）之 NSObject+YYModel》/" data-title="《YYModel 源码解析（二）之 NSObject+YYModel》 | DevZhang的博客小屋" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2019/05/16/《YYModel 源码解析（一）之 YYClassInfo》/"  title="《YYModel 源码解析（一）之 YYClassInfo》">
 <strong>下一篇：</strong><br/> 
 <span>《YYModel 源码解析（一）之 YYClassInfo》
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#《YYModel-源码解析（二）之-NSObject-YYModel》"><span class="toc-number">1.</span> <span class="toc-text">《YYModel 源码解析（二）之 NSObject+YYModel》</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#类型编码解析"><span class="toc-number">1.1.</span> <span class="toc-text">类型编码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYEncodingNSType"><span class="toc-number">1.1.1.</span> <span class="toc-text">YYEncodingNSType</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYClassGetNSType"><span class="toc-number">1.1.2.</span> <span class="toc-text">YYClassGetNSType</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYEncodingTypeIsCNumber"><span class="toc-number">1.1.3.</span> <span class="toc-text">YYEncodingTypeIsCNumber</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYNSNumberCreateFromID"><span class="toc-number">1.1.4.</span> <span class="toc-text">YYNSNumberCreateFromID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYNSDateFromString"><span class="toc-number">1.1.5.</span> <span class="toc-text">YYNSDateFromString</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYNSBlockClass"><span class="toc-number">1.1.6.</span> <span class="toc-text">YYNSBlockClass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#强制内联"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">强制内联</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据结构的定义"><span class="toc-number">1.2.</span> <span class="toc-text">数据结构的定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYModelPropertyMeta"><span class="toc-number">1.2.1.</span> <span class="toc-text">_YYModelPropertyMeta</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYModelMeta"><span class="toc-number">1.2.2.</span> <span class="toc-text">_YYModelMeta</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对外开放的接口"><span class="toc-number">1.3.</span> <span class="toc-text">对外开放的接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSArray-YYModel"><span class="toc-number">1.3.1.</span> <span class="toc-text">NSArray (YYModel)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSDictionary-YYModel"><span class="toc-number">1.3.2.</span> <span class="toc-text">NSDictionary (YYModel)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#model-转-JSON-data"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">model 转 JSON data</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#model-转-JSON"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">model 转 JSON</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-和-Model-的互转"><span class="toc-number">1.4.</span> <span class="toc-text">JSON 和 Model 的互转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON-to-Model"><span class="toc-number">1.4.1.</span> <span class="toc-text">JSON to Model</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-to-NSDictionary"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">JSON to NSDictionary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSDictionary-to-Model"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">NSDictionary to Model</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Model-to-JSON"><span class="toc-number">1.4.2.</span> <span class="toc-text">Model to JSON</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">1.6.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  

  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> 积跬步以至千里 <br/>
			凭栏眺望会有时</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="CSAMEN">CSAMEN</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
